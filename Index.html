import React, { useState, useEffect, useMemo } from 'react';
import { PlusCircle, LayoutDashboard, Table, Download, PieChart, Settings, Save, Trash2, FileText, Wallet, RefreshCw, Link2, CheckCircle, AlertCircle } from 'lucide-react';

// --- é è¨­æ¨¡æ“¬è³‡æ–™ (ç•¶æ²’æœ‰é€£ç·šæ™‚ä½¿ç”¨) ---
const MOCK_PROJECTS = [
  { id: 'PROJ_001', name: '113å¹´åº¦éƒ¨è½æ–‡åŒ–å‚³æ‰¿è¨ˆç•«', budget: 500000, funder: 'åŸæ°‘æœƒ' },
  { id: 'PROJ_002', name: 'èŠ±è“®ç¸£ç’°å¢ƒæ•™è‚²æ¨å»£æ¡ˆ', budget: 120000, funder: 'èŠ±è“®ç¸£ç’°ä¿å±€' }
];

const MOCK_CATEGORIES = [
  { type: 'expense', name: 'æ¥­å‹™è²»-è¬›å¸«è²»' },
  { type: 'expense', name: 'æ¥­å‹™è²»-ææ–™è²»' },
  { type: 'expense', name: 'é›œæ”¯' },
  { type: 'income', name: 'æ”¿åºœè£œåŠ©æ¬¾' },
  { type: 'income', name: 'ä¸€èˆ¬ææ¬¾' }
];

export default function AccountingAppV2() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(false);
  const [notification, setNotification] = useState(null);
  
  // --- è³‡æ–™ç‹€æ…‹ ---
  const [transactions, setTransactions] = useState([]);
  const [projects, setProjects] = useState(MOCK_PROJECTS);
  const [categories, setCategories] = useState(MOCK_CATEGORIES);
  
  // --- è¨­å®šç‹€æ…‹ (API URL) ---
  const [apiUrl, setApiUrl] = useState('');
  const [isConnected, setIsConnected] = useState(false);

  // è¡¨å–®ç‹€æ…‹
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    type: 'expense',
    projectId: '',
    category: '',
    summary: '',
    amount: '',
    payee: '',
    note: ''
  });

  // 1. åˆå§‹åŒ–ï¼šè®€å–è¨­å®šèˆ‡è³‡æ–™
  useEffect(() => {
    // å˜—è©¦è®€å–å„²å­˜çš„ API URL
    const savedUrl = localStorage.getItem('onanip_api_url');
    if (savedUrl) {
      setApiUrl(savedUrl);
      fetchDataFromGoogleSheet(savedUrl);
    } else {
      // ç„¡é€£ç·šï¼Œè®€å–æœ¬åœ°æ¨¡æ“¬è³‡æ–™
      const savedLocalData = localStorage.getItem('onanip_local_data');
      if (savedLocalData) {
        setTransactions(JSON.parse(savedLocalData));
      }
    }
  }, []);

  // 2. ç•¶è³‡æ–™è®Šå‹•ä¸”åœ¨æ¨¡æ“¬æ¨¡å¼æ™‚ï¼Œå­˜å…¥ LocalStorage
  useEffect(() => {
    if (!isConnected) {
      localStorage.setItem('onanip_local_data', JSON.stringify(transactions));
    }
  }, [transactions, isConnected]);

  // --- API ä¸²æ¥é‚è¼¯ ---

  const fetchDataFromGoogleSheet = async (url) => {
    if (!url) return;
    setLoading(true);
    try {
      const response = await fetch(url);
      const data = await response.json();
      
      if (data) {
        setProjects(data.projects || []);
        setTransactions(data.transactions || []);
        if (data.categories && data.categories.length > 0) {
            setCategories(data.categories);
        }
        setIsConnected(true);
        showNotify('âœ… å·²æˆåŠŸé€£ç·šè‡³ Google Sheetï¼');
      }
    } catch (error) {
      console.error("é€£ç·šå¤±æ•—:", error);
      showNotify('âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€æˆ–æ¬Šé™è¨­å®š', 'error');
      setIsConnected(false);
    } finally {
      setLoading(false);
    }
  };

  const saveDataToGoogleSheet = async (newTransaction) => {
    // æ¨‚è§€æ›´æ–° UI (Optimistic UI Update)
    setTransactions(prev => [newTransaction, ...prev]);
    
    // å¦‚æœæ˜¯é€£ç·šæ¨¡å¼ï¼Œç™¼é€ POST è«‹æ±‚
    if (isConnected && apiUrl) {
      try {
        // å› ç‚º Google Apps Script éœ€è¦ CORS è™•ç†ï¼Œé€šå¸¸å‰ç«¯ä½¿ç”¨ no-cors æˆ–æ˜¯é€é text/plain
        // é€™è£¡ç¤ºç¯„æ¨™æº– fetchï¼Œè‹¥é‡ CORS å•é¡Œé€šå¸¸æ˜¯ GAS éƒ¨ç½²æ¬Šé™æ²’è¨­ç‚º Anyone
        await fetch(apiUrl, {
          method: 'POST',
          mode: 'no-cors', // é‡è¦ï¼šGAS webapp é€šå¸¸éœ€è¦é€™å€‹
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: 'add',
            ...newTransaction
          })
        });
        // è¨»ï¼šno-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–å›æ‡‰ï¼Œæˆ‘å€‘å‡è¨­æˆåŠŸ
        showNotify('âœ… è³‡æ–™å·²å¯«å…¥é›²ç«¯');
      } catch (error) {
        showNotify('âš ï¸ å¯«å…¥é›²ç«¯å¤±æ•—ï¼Œè«‹ç¨å¾Œæ‰‹å‹•åŒæ­¥', 'error');
      }
    } else {
      showNotify('âœ… è³‡æ–™å·²å„²å­˜ (æœ¬æ©Ÿæ¨¡å¼)');
    }
  };
  
  const deleteDataFromGoogleSheet = async (id) => {
     setTransactions(prev => prev.filter(t => t.id !== id));
     
     if (isConnected && apiUrl) {
         try {
             await fetch(apiUrl, {
                 method: 'POST',
                 mode: 'no-cors',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ action: 'delete', id: id })
             });
             showNotify('ğŸ—‘ï¸ è³‡æ–™å·²å¾é›²ç«¯åˆªé™¤');
         } catch (e) {
             showNotify('âš ï¸ åˆªé™¤å¤±æ•—', 'error');
         }
     } else {
         showNotify('ğŸ—‘ï¸ è³‡æ–™å·²åˆªé™¤ (æœ¬æ©Ÿæ¨¡å¼)');
     }
  };

  // --- UI è¼”åŠ© ---
  const showNotify = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSaveSettings = () => {
    localStorage.setItem('onanip_api_url', apiUrl);
    fetchDataFromGoogleSheet(apiUrl);
  };

  const handleClearSettings = () => {
    localStorage.removeItem('onanip_api_url');
    setApiUrl('');
    setIsConnected(false);
    setCategories(MOCK_CATEGORIES); // å›å¾©é è¨­
    showNotify('å·²åˆ‡æ›å›æ¨¡æ“¬æ¨¡å¼');
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!formData.amount || !formData.summary || !formData.projectId) {
      showNotify('è«‹å¡«å¯«å®Œæ•´ï¼šé‡‘é¡ã€æ‘˜è¦èˆ‡è¨ˆç•«', 'error');
      return;
    }

    const newTransaction = {
      id: Date.now().toString(), // ç¢ºä¿ ID æ˜¯å­—ä¸²
      ...formData,
      amount: parseInt(formData.amount)
    };

    saveDataToGoogleSheet(newTransaction);
    
    // é‡ç½®è¡¨å–® (ä¿ç•™éƒ¨åˆ†é¸é …æ–¹ä¾¿é€£çºŒè¼¸å…¥)
    setFormData(prev => ({
      ...prev,
      amount: '',
      summary: '',
      payee: '',
      note: ''
    }));
  };

  // --- è¨ˆç®—é‚è¼¯ ---
  const stats = useMemo(() => {
    const totalIncome = transactions.filter(t => String(t.type) === 'income').reduce((acc, curr) => acc + (parseInt(curr.amount)||0), 0);
    const totalExpense = transactions.filter(t => String(t.type) === 'expense').reduce((acc, curr) => acc + (parseInt(curr.amount)||0), 0);
    
    const projectStats = projects.map(proj => {
      const used = transactions
        .filter(t => String(t.projectId) === String(proj.id) && String(t.type) === 'expense')
        .reduce((acc, curr) => acc + (parseInt(curr.amount)||0), 0);
      return {
        ...proj,
        used,
        percent: Math.round((used / proj.budget) * 100) || 0
      };
    });

    return { totalIncome, totalExpense, projectStats };
  }, [transactions, projects]);

  // éæ¿¾ç•¶å‰é©ç”¨çš„ç§‘ç›® (æ ¹æ“šæ”¶å…¥/æ”¯å‡º)
  const currentCategories = useMemo(() => {
      return categories.filter(c => c.type === formData.type);
  }, [categories, formData.type]);
  
  // ç¢ºä¿åˆ‡æ› type æ™‚ï¼Œcategory é è¨­å€¼ä¹Ÿè·Ÿè‘—æ›
  useEffect(() => {
      if (currentCategories.length > 0) {
          // å¦‚æœç•¶å‰é¸çš„ç§‘ç›®ä¸åœ¨æ–°çš„æ¸…å–®ä¸­ï¼Œå°±é¸ç¬¬ä¸€å€‹
          const isValid = currentCategories.find(c => c.name === formData.category);
          if (!isValid) {
              setFormData(prev => ({ ...prev, category: currentCategories[0].name }));
          }
      }
  }, [formData.type, currentCategories]);


  return (
    <div className="min-h-screen bg-slate-50 text-slate-800 font-sans pb-20 md:pb-0">
      {/* é ‚éƒ¨å°èˆª */}
      <nav className={`shadow-lg sticky top-0 z-50 transition-colors ${isConnected ? 'bg-teal-700' : 'bg-slate-700'}`}>
        <div className="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center text-white">
          <div className="flex items-center space-x-3">
            <div className="bg-white p-1.5 rounded-full text-teal-700">
              <Wallet className="w-5 h-5" />
            </div>
            <div>
              <h1 className="text-lg font-bold tracking-wide hidden md:block">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1>
              <h1 className="text-lg font-bold tracking-wide md:hidden">'onanip æœƒè¨ˆ</h1>
              <div className="flex items-center space-x-2 text-xs opacity-90">
                 {isConnected ? (
                     <span className="flex items-center text-emerald-300"><CheckCircle className="w-3 h-3 mr-1"/>é›²ç«¯å·²é€£ç·š</span>
                 ) : (
                     <span className="flex items-center text-orange-300"><AlertCircle className="w-3 h-3 mr-1"/>æ¨¡æ“¬æ¨¡å¼</span>
                 )}
              </div>
            </div>
          </div>
          <button onClick={() => setActiveTab('settings')} className="p-2 hover:bg-white/10 rounded-full transition-colors">
            <Settings className="w-5 h-5" />
          </button>
        </div>
      </nav>

      {/* é€šçŸ¥è¨Šæ¯ */}
      {notification && (
        <div className={`fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl animate-bounce z-50 text-white ${notification.type === 'error' ? 'bg-rose-600' : 'bg-emerald-600'}`}>
          {notification.msg}
        </div>
      )}

      {/* ä¸»è¦å…§å®¹å€ */}
      <main className="max-w-5xl mx-auto px-4 py-6">
        
        {loading ? (
            <div className="flex flex-col items-center justify-center py-20 text-slate-400">
                <RefreshCw className="w-10 h-10 animate-spin mb-4" />
                <p>æ­£åœ¨å¾ Google Sheet è®€å–è³‡æ–™...</p>
            </div>
        ) : (
        <div className="space-y-6">
          
          {/* --- DASHBOARD --- */}
          {activeTab === 'dashboard' && (
            <div className="space-y-6 animate-fade-in">
              {/* ç‹€æ…‹å¡ç‰‡ */}
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                  <p className="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¶å…¥</p>
                  <p className="text-2xl font-bold text-slate-800">${stats.totalIncome.toLocaleString()}</p>
                </div>
                <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-500">
                  <p className="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¯å‡º</p>
                  <p className="text-2xl font-bold text-slate-800">${stats.totalExpense.toLocaleString()}</p>
                </div>
              </div>

              {/* é ç®—ç›£æ§ */}
              <div className="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
                <h3 className="font-bold text-slate-700 mb-4 flex items-center">
                  <PieChart className="w-5 h-5 mr-2 text-teal-600" />
                  è¨ˆç•«é ç®—ç›£æ§
                </h3>
                <div className="space-y-4">
                  {stats.projectStats.map(proj => (
                    <div key={proj.id} className="pb-3 border-b border-slate-50 last:border-0 last:pb-0">
                      <div className="flex justify-between items-end mb-1">
                        <span className="font-medium text-slate-700 text-sm">{proj.name}</span>
                        <span className="text-xs text-slate-500">
                            å·²ç”¨ <span className="font-bold text-slate-700">${proj.used.toLocaleString()}</span> / {proj.budget.toLocaleString()}
                        </span>
                      </div>
                      <div className="w-full bg-slate-100 rounded-full h-2">
                        <div 
                          className={`h-2 rounded-full transition-all duration-500 ${proj.percent > 90 ? 'bg-rose-500' : proj.percent > 70 ? 'bg-amber-400' : 'bg-teal-500'}`} 
                          style={{ width: `${Math.min(proj.percent, 100)}%` }}
                        ></div>
                      </div>
                    </div>
                  ))}
                  {projects.length === 0 && <p className="text-sm text-slate-400 text-center py-4">æ²’æœ‰è®€å–åˆ°è¨ˆç•«è³‡æ–™</p>}
                </div>
              </div>
            </div>
          )}

          {/* --- ENTRY FORM --- */}
          {activeTab === 'entry' && (
            <div className="bg-white rounded-2xl shadow-md p-6 border border-slate-100 animate-fade-in max-w-2xl mx-auto">
              <h2 className="text-lg font-bold text-slate-700 mb-6 flex items-center">
                <FileText className="w-5 h-5 mr-2 text-teal-600" />
                æ–°å¢å‚³ç¥¨
              </h2>
              
              <form onSubmit={handleSubmit} className="space-y-5">
                {/* æ”¶å…¥/æ”¯å‡ºåˆ‡æ› */}
                <div className="flex bg-slate-100 p-1 rounded-lg">
                  <button
                    type="button"
                    onClick={() => setFormData({ ...formData, type: 'expense' })}
                    className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${formData.type === 'expense' ? 'bg-white text-rose-600 shadow-sm' : 'text-slate-500'}`}
                  >
                    æ”¯å‡º
                  </button>
                  <button
                    type="button"
                    onClick={() => setFormData({ ...formData, type: 'income' })}
                    className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${formData.type === 'income' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500'}`}
                  >
                    æ”¶å…¥
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs font-semibold text-slate-500 mb-1">æ—¥æœŸ</label>
                    <input 
                      type="date" 
                      name="date"
                      required
                      value={formData.date}
                      onChange={handleInputChange}
                      className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-semibold text-slate-500 mb-1">é‡‘é¡</label>
                    <input 
                      type="number" 
                      name="amount"
                      required
                      placeholder="0"
                      value={formData.amount}
                      onChange={handleInputChange}
                      className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none font-mono"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-semibold text-slate-500 mb-1">æ­¸å±¬è¨ˆç•«</label>
                  <select 
                    name="projectId"
                    value={formData.projectId}
                    onChange={handleInputChange}
                    className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white"
                  >
                    <option value="" disabled>-- è«‹é¸æ“‡è¨ˆç•« --</option>
                    {projects.map(p => (
                      <option key={p.id} value={p.id}>{p.name}</option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-xs font-semibold text-slate-500 mb-1">
                      æœƒè¨ˆç§‘ç›® 
                      {isConnected && <span className="text-[10px] text-teal-600 ml-1">(ä¾†è‡ªé›²ç«¯)</span>}
                  </label>
                  <select 
                    name="category"
                    value={formData.category}
                    onChange={handleInputChange}
                    className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white"
                  >
                    {currentCategories.length === 0 && <option>ç„¡å¯ç”¨ç§‘ç›®</option>}
                    {currentCategories.map(c => (
                      <option key={c.name} value={c.name}>{c.name}</option>
                    ))}
                  </select>
                </div>

                <div>
                  <label className="block text-xs font-semibold text-slate-500 mb-1">æ‘˜è¦</label>
                  <input 
                    type="text" 
                    name="summary"
                    required
                    placeholder="èªªæ˜ç”¨é€”..."
                    value={formData.summary}
                    onChange={handleInputChange}
                    className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none"
                  />
                </div>
                
                <div className="grid grid-cols-2 gap-4">
                     <div>
                        <label className="block text-xs font-semibold text-slate-500 mb-1">å°è±¡ (Payee)</label>
                        <input type="text" name="payee" value={formData.payee} onChange={handleInputChange} className="w-full p-2 border border-slate-300 rounded-lg outline-none" />
                     </div>
                     <div>
                        <label className="block text-xs font-semibold text-slate-500 mb-1">å‚™è¨»</label>
                        <input type="text" name="note" value={formData.note} onChange={handleInputChange} className="w-full p-2 border border-slate-300 rounded-lg outline-none" />
                     </div>
                </div>

                <button 
                  type="submit" 
                  className={`w-full font-bold py-3 rounded-xl shadow-md transition-transform active:scale-95 flex items-center justify-center text-white
                    ${formData.type === 'expense' ? 'bg-rose-600 hover:bg-rose-700' : 'bg-emerald-600 hover:bg-emerald-700'}`}
                >
                  <Save className="w-5 h-5 mr-2" />
                  å„²å­˜{formData.type === 'expense' ? 'æ”¯å‡º' : 'æ”¶å…¥'}
                </button>
              </form>
            </div>
          )}

          {/* --- SETTINGS --- */}
          {activeTab === 'settings' && (
            <div className="bg-white rounded-2xl shadow-md p-6 border border-slate-100 animate-fade-in">
                <h2 className="text-xl font-bold text-slate-700 mb-4 flex items-center">
                    <Link2 className="w-6 h-6 mr-2 text-teal-600" />
                    é€£ç·šè¨­å®š
                </h2>
                
                <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6 text-sm text-blue-800">
                    <h4 className="font-bold mb-2">å¦‚ä½•é€£ç·šåˆ°æ‚¨çš„ Google Sheet?</h4>
                    <ol className="list-decimal ml-5 space-y-1">
                        <li>ç¢ºèªæ‚¨å·²åœ¨ Google Sheet å»ºç«‹ <code>Transactions</code>, <code>Projects</code>, <code>Categories</code> ä¸‰å€‹å·¥ä½œè¡¨ã€‚</li>
                        <li>ç¢ºèªæ‚¨å·²å°‡ Apps Script éƒ¨ç½²ç‚ºã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ï¼Œæ¬Šé™è¨­ç‚ºã€Œæ‰€æœ‰äºº (Anyone)ã€ã€‚</li>
                        <li>å°‡éƒ¨ç½²ç”¢ç”Ÿçš„ç¶²å€è²¼åœ¨ä¸‹æ–¹ã€‚</li>
                    </ol>
                </div>

                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-semibold text-slate-700 mb-1">Google Apps Script ç¶²å€ (Web App URL)</label>
                        <input 
                            type="text" 
                            value={apiUrl}
                            onChange={(e) => setApiUrl(e.target.value)}
                            placeholder="https://script.google.com/macros/s/..../exec"
                            className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none text-sm font-mono text-slate-600"
                        />
                    </div>
                    
                    <div className="flex space-x-3">
                        <button 
                            onClick={handleSaveSettings}
                            className="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition-colors flex justify-center items-center"
                        >
                            <RefreshCw className="w-4 h-4 mr-2" />
                            å„²å­˜ä¸¦æ¸¬è©¦é€£ç·š
                        </button>
                        {isConnected && (
                             <button 
                                onClick={handleClearSettings}
                                className="px-4 border border-rose-200 text-rose-600 hover:bg-rose-50 font-bold py-2 rounded-lg transition-colors"
                            >
                                æ–·é–‹
                            </button>
                        )}
                    </div>

                    {isConnected && (
                        <div className="mt-4 p-3 bg-emerald-50 text-emerald-700 rounded-lg text-sm flex items-center">
                            <CheckCircle className="w-5 h-5 mr-2" />
                            é€£ç·šæˆåŠŸï¼è³‡æ–™å·²åŒæ­¥ã€‚
                        </div>
                    )}
                </div>
            </div>
          )}

          {/* --- LIST --- */}
          {activeTab === 'list' && (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden animate-fade-in">
                <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left">
                    <thead className="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                      <tr>
                        <th className="px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
                        <th className="px-4 py-3 whitespace-nowrap">æ‘˜è¦</th>
                        <th className="px-4 py-3 text-right whitespace-nowrap">é‡‘é¡</th>
                        <th className="px-4 py-3 text-center">åˆªé™¤</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => (
                        <tr key={t.id} className="hover:bg-slate-50">
                          <td className="px-4 py-3 align-top whitespace-nowrap">
                            <div className="font-mono text-slate-600">{t.date}</div>
                            <div className="text-xs text-slate-400">{projects.find(p=>String(p.id)===String(t.projectId))?.name}</div>
                          </td>
                          <td className="px-4 py-3 align-top">
                            <div className="font-medium text-slate-800">{t.summary}</div>
                            <div className="text-xs text-slate-500">{t.category}</div>
                          </td>
                          <td className={`px-4 py-3 text-right font-mono font-bold align-top ${String(t.type) === 'income' ? 'text-emerald-600' : 'text-rose-600'}`}>
                            {String(t.type) === 'income' ? '+' : '-'}{Number(t.amount).toLocaleString()}
                          </td>
                          <td className="px-4 py-3 text-center">
                             <button onClick={() => deleteDataFromGoogleSheet(t.id)} className="text-slate-300 hover:text-rose-500">
                                 <Trash2 className="w-4 h-4" />
                             </button>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
            </div>
          )}
        </div>
        )}

        {/* æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆª */}
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 md:hidden flex justify-around items-center z-50 pb-safe">
            {[
                { id: 'dashboard', icon: LayoutDashboard, label: 'ç¸½è¦½' },
                { id: 'entry', icon: PlusCircle, label: 'è¨˜å¸³' },
                { id: 'list', icon: Table, label: 'æ˜ç´°' },
            ].map(tab => (
                <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex flex-col items-center p-2 rounded-lg transition-colors ${activeTab === tab.id ? 'text-teal-600' : 'text-slate-400'}`}
                >
                    <tab.icon className="w-6 h-6" />
                    <span className="text-[10px] mt-1">{tab.label}</span>
                </button>
            ))}
        </div>

      </main>
    </div>
  );
}
