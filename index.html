<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ - æœƒè¨ˆç³»çµ± (V36 Domain Restricted)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ html2pdf ç”¨æ–¼ç”¢ç”Ÿ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* è¢å¹•é è¦½æ¨£å¼ */
        .preview-table { width: 100%; border-collapse: collapse; border: 1px solid #333; margin-bottom: 20px; }
        .preview-table th, .preview-table td { border: 1px solid #333; padding: 6px 8px; font-size: 14px; }
        .preview-table th { background-color: #f3f4f6; text-align: center; font-weight: bold; }
        .amount-col { text-align: right; font-family: monospace; }
        .sign-box { height: 80px; vertical-align: bottom; text-align: center; }
        /* èª¿æ•´æ†‘è­‰é»è²¼è™•é«˜åº¦è‡³ 400px (åŠ å¤§) */
        .attachment-area { border: 2px dashed #94a3b8; height: 400px; display: flex; align-items: center; justify-content: center; background-color: #f8fafc; color: #64748b; font-weight: bold; margin: 15px 0; }

        /* PDF è¼¸å‡ºå°ˆç”¨èª¿æ•´ */
        .pdf-content {
            font-size: 12pt;
            line-height: 1.5;
        }
        
        /* é ç®—çµ±è¨ˆè³‡è¨Šå€å¡Š */
        .budget-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            font-size: 0.9em;
        }
        .budget-item {
            text-align: center;
        }
        .budget-label {
            font-size: 0.8em;
            color: #64748b;
        }
        .budget-value {
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1em;
        }
        /* é—œå¸³ç‹€æ…‹æ¨£å¼ */
        .project-closed {
            background-color: #f1f5f9;
            opacity: 0.8;
            border-style: dashed;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-24 md:pb-10">

    <!-- Login -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-800 z-[150] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-500 to-emerald-500"></div>
            <div class="text-center mb-8">
                <div class="bg-teal-50 p-4 rounded-full inline-block mb-4 ring-4 ring-teal-100"><i data-lucide="shield-check" class="w-10 h-10 text-teal-600"></i></div>
                <h1 class="text-2xl font-bold text-slate-800">'onanip æœƒè¨ˆç³»çµ± V36</h1>
                <p class="text-xs text-slate-400 mt-2">åƒ…é™ @onanip.org ç¶²åŸŸç™»å…¥</p>
            </div>
            
            <!-- Google Login Button -->
            <div class="space-y-5">
                <button id="btn-google-login" onclick="window.firebaseLogin()" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-3 rounded-xl hover:bg-slate-50 transition-all flex justify-center items-center shadow-sm gap-3">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6" alt="Google">
                    ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                </button>
            </div>

            <div id="login-msg" class="mt-4 text-center text-rose-500 text-sm font-bold hidden bg-rose-50 p-2 rounded"></div>
        </div>
    </div>

    <!-- Nav -->
    <nav id="navbar" class="bg-slate-700 text-white shadow-lg sticky top-0 z-50 transition-colors duration-300 no-print">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-1.5 rounded-full text-slate-700"><i data-lucide="wallet" class="w-6 h-6"></i></div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide hidden md:block">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1>
                    <h1 class="text-lg font-bold tracking-wide md:hidden">'onanip æœƒè¨ˆ</h1>
                    <div id="user-badge" class="flex items-center space-x-2 text-xs opacity-90 text-slate-300"><i data-lucide="user" class="w-3 h-3"></i><span id="user-display">æœªç™»å…¥</span></div>
                </div>
            </div>
            <div class="hidden md:flex space-x-2 bg-slate-800/50 p-1 rounded-lg">
                <button onclick="switchTab('dashboard')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-teal-300 bg-white/10">ç¸½è¦½</button>
                <button onclick="switchTab('entry')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:bg-white/10">è¨˜å¸³</button>
                <button onclick="switchTab('list')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:bg-white/10">æ˜ç´°</button>
                <button onclick="switchTab('projects')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:bg-white/10">è¨ˆç•«</button>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="handleLogout()" class="p-2 hover:bg-rose-600 rounded-full border border-white/20" title="ç™»å‡º"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 py-6 no-print">
        <!-- Settings View Removed (URL Hardcoded) -->

        <!-- Dashboard -->
        <div id="view-dashboard" class="view-section hidden fade-in">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500"><p class="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¶å…¥</p><p id="total-income" class="text-2xl font-bold text-slate-800">$0</p></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-500"><p class="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¯å‡º</p><p id="total-expense" class="text-2xl font-bold text-slate-800">$0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-100"><div id="project-stats" class="space-y-4"></div></div>
        </div>

        <!-- Entry Form -->
        <div id="view-entry" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100 max-w-2xl mx-auto relative">
                <div id="edit-mode-indicator" class="hidden absolute top-0 right-0 bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-bl-lg rounded-tr-lg border-b border-l border-amber-200">ä¿®æ”¹æ¨¡å¼</div>
                <h2 class="text-lg font-bold text-slate-700 mb-6 flex items-center"><i data-lucide="file-plus" class="w-6 h-6 mr-2 text-teal-600"></i> <span id="form-title">æ–°å¢ç´€éŒ„</span></h2>
                <form id="entry-form" class="space-y-5">
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button type="button" onclick="setType('expense')" id="btn-expense" class="flex-1 py-3 rounded-md text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">æ”¯å‡º</button>
                        <button type="button" onclick="setType('income')" id="btn-income" class="flex-1 py-3 rounded-md text-sm font-bold text-slate-500 transition-all">æ”¶å…¥</button>
                    </div>
                    <input type="hidden" id="inp-type" value="expense"><input type="hidden" id="inp-id" value="">
                    <div class="grid grid-cols-2 gap-4"><input type="date" id="inp-date" required class="w-full p-3 border rounded-lg"><input type="number" id="inp-amount" required placeholder="é‡‘é¡" class="w-full p-3 border rounded-lg font-mono"></div>
                    <select id="inp-project" required class="w-full p-3 border rounded-lg bg-white"></select><select id="inp-category" required class="w-full p-3 border rounded-lg bg-white"></select>
                    <input type="text" id="inp-summary" required placeholder="æ‘˜è¦" class="w-full p-3 border rounded-lg">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="inp-payee" placeholder="å°è±¡ (å—æ¬¾äºº)" class="w-full p-3 border rounded-lg">
                        <input type="text" id="inp-bank-account" placeholder="åŒ¯æ¬¾å¸³è™Ÿ (14ç¢¼)" maxlength="14" class="w-full p-3 border rounded-lg" onblur="autoPadAccount(this)">
                    </div>
                    <input type="text" id="inp-note" placeholder="å‚™è¨»" class="w-full p-3 border rounded-lg">
                    
                    <div class="flex space-x-3">
                        <button type="button" id="btn-cancel-edit" onclick="cancelEdit()" class="hidden w-1/3 bg-slate-200 text-slate-600 font-bold py-4 rounded-xl">å–æ¶ˆ</button>
                        <button type="submit" id="btn-submit" class="w-full bg-rose-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜ä¸¦åˆ—å°</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- List -->
        <div id="view-list" class="view-section hidden fade-in">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-slate-700">æ”¶æ”¯æ˜ç´°</h3>
                <button onclick="openReportModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center font-bold text-sm hover:bg-indigo-700 shadow-md">
                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> ä¸‹è¼‰å ±è¡¨ (PDF)
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden min-h-[300px]">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th class="px-4 py-3">å…§å®¹</th><th class="px-4 py-3 text-right">é‡‘é¡ / ç‹€æ…‹</th><th class="px-4 py-3 text-center w-[120px]">æ“ä½œ</th></tr></thead>
                    <tbody id="list-body" class="divide-y divide-slate-100"></tbody>
                </table>
                <div id="pagination-controls" class="flex justify-between items-center px-4 py-3 bg-slate-50 border-t border-slate-200">
                    <button onclick="prevPage()" id="btn-prev-page" class="px-3 py-1 bg-white border border-slate-300 rounded text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed flex items-center text-xs font-bold">
                        <i data-lucide="chevron-left" class="w-4 h-4 mr-1"></i> ä¸Šä¸€é 
                    </button>
                    <span id="page-info" class="text-xs font-bold text-slate-500">ç¬¬ 1 é </span>
                    <button onclick="nextPage()" id="btn-next-page" class="px-3 py-1 bg-white border border-slate-300 rounded text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed flex items-center text-xs font-bold">
                        ä¸‹ä¸€é  <i data-lucide="chevron-right" class="w-4 h-4 ml-1"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Projects -->
        <div id="view-projects" class="view-section hidden fade-in">
             <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center"><i data-lucide="list" class="w-6 h-6 mr-2 text-teal-600"></i> è¨ˆç•«åˆ—è¡¨</h2>
                <div id="projects-list-content" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 fade-in">
            <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">ğŸ–¨ï¸ ç”¢å‡ºè²¡å‹™å ±è¡¨</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-600 mb-1">ç¯©é¸è¨ˆç•«</label><select id="rpt-project" class="w-full p-2 border rounded bg-white"><option value="ALL">å…¨éƒ¨è¨ˆç•«</option></select></div>
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">æœˆä»½ / æœŸé–“</label>
                    <div class="flex items-center space-x-2">
                        <input type="month" id="rpt-month" class="flex-1 p-2 border rounded bg-white">
                        <label class="flex items-center space-x-1 text-sm text-slate-600 bg-slate-50 px-2 py-2 rounded border cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" id="rpt-full-year" onchange="toggleReportDate()" class="rounded text-indigo-600">
                            <span>åˆ—å°å…¨å¹´åº¦</span>
                        </label>
                    </div>
                </div>
                <div><label class="block text-sm font-bold text-slate-600 mb-2">å ±è¡¨é¡å‹</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-2 border rounded hover:bg-slate-50"><input type="radio" name="rpt-type" value="journal" checked class="mr-2">æ—¥è¨˜å¸³ (ç›´å¼)</label>
                        <label class="flex items-center p-2 border rounded hover:bg-slate-50"><input type="radio" name="rpt-type" value="ledger" class="mr-2">åˆ†é¡å¸³ (æ©«å¼)</label>
                        <label class="flex items-center p-2 border rounded hover:bg-slate-50"><input type="radio" name="rpt-type" value="monthly" class="mr-2">æ”¶æ”¯æœˆå ±è¡¨ (ç›´å¼)</label>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="w-1/2 bg-slate-200 text-slate-600 font-bold py-3 rounded-xl">å–æ¶ˆ</button>
                <button onclick="generateReport()" class="w-1/2 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg">ä¸‹è¼‰ PDF</button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="print-modal" class="fixed inset-0 bg-black/50 z-[250] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-3xl p-4 rounded-lg shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-slate-700">é è¦½èˆ‡ä¸‹è¼‰</h3>
                <button onclick="document.getElementById('print-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div id="printable-area" class="flex-1 overflow-y-auto overflow-x-auto bg-slate-50 p-4 border rounded">
                <div id="print-content" class="bg-white p-4 shadow-sm mx-auto"></div>
            </div>

            <div class="mt-4 flex justify-end space-x-4">
                <button onclick="document.getElementById('print-modal').classList.add('hidden')" class="px-6 py-2 border rounded-lg font-bold">é—œé–‰</button>
                <button onclick="downloadCurrentPDF()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-bold flex items-center shadow-lg active:scale-95 transition-transform"><i data-lucide="download" class="w-5 h-5 mr-2"></i> å„²å­˜ PDF</button>
            </div>
        </div>
    </div>

    <!-- Toast & Loading & Mobile Nav -->
    <div id="toast" class="hidden fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl z-[300] text-white transition-all duration-300 transform"><span id="toast-msg"></span></div>
    <div id="loading" class="fixed inset-0 bg-white/90 z-[300] hidden flex flex-col items-center justify-center backdrop-blur-sm"><i data-lucide="loader-2" class="w-12 h-12 animate-spin text-teal-600 mb-4"></i><p class="text-slate-600 font-bold text-lg">è™•ç†ä¸­...</p></div>
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 flex justify-around z-50 pb-safe no-print">
        <button onclick="switchTab('dashboard')" class="nav-btn text-teal-600 flex flex-col items-center p-2 w-full"><i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="text-[10px]">ç¸½è¦½</span></button>
        <button onclick="switchTab('entry')" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-full"><i data-lucide="plus-circle" class="w-6 h-6"></i><span class="text-[10px]">è¨˜å¸³</span></button>
        <button onclick="switchTab('list')" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-full"><i data-lucide="table" class="w-6 h-6"></i><span class="text-[10px]">æ˜ç´°</span></button>
        <button onclick="switchTab('projects')" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-full"><i data-lucide="list" class="w-6 h-6"></i><span class="text-[10px]">è¨ˆç•«</span></button>
    </div>

    <!-- Main Application Logic (Placed BEFORE Firebase to ensure globals are ready) -->
    <script>
        // --- Core Functions Definition ---
        
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            const target = document.getElementById('view-' + tabId);
            if(target) {
                target.classList.remove('hidden');
                window.scrollTo(0, 0);
            }
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-teal-600');
                btn.classList.add('text-slate-400');
            });
            document.querySelectorAll('.desktop-nav-btn').forEach(btn => {
                btn.classList.remove('text-teal-300', 'bg-white/10');
                btn.classList.add('text-slate-300');
            });
        }

        function showLoading(isLoading) {
            const el = document.getElementById('loading');
            if(isLoading) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const el = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            msgEl.innerText = message;
            el.className = 'fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl z-[300] text-white transition-all duration-300 transform';
            if(type === 'error') el.classList.add('bg-rose-600');
            else el.classList.add('bg-emerald-600');
            el.classList.remove('hidden');
            if(window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => {
                el.classList.add('hidden');
            }, 3000);
        }

        function setType(type) {
            document.getElementById('inp-type').value = type;
            const btnInc = document.getElementById('btn-income');
            const btnExp = document.getElementById('btn-expense');
            const title = document.getElementById('form-title');
            if(type === 'income') {
                btnInc.className = 'flex-1 py-3 rounded-md text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all';
                btnExp.className = 'flex-1 py-3 rounded-md text-sm font-bold text-slate-500 transition-all';
                title.innerHTML = 'æ–°å¢æ”¶å…¥';
                title.parentElement.querySelector('i').className = 'w-6 h-6 mr-2 text-emerald-600';
            } else {
                btnInc.className = 'flex-1 py-3 rounded-md text-sm font-bold text-slate-500 transition-all';
                btnExp.className = 'flex-1 py-3 rounded-md text-sm font-bold bg-white text-rose-600 shadow-sm transition-all';
                title.innerHTML = 'æ–°å¢æ”¯å‡º';
                title.parentElement.querySelector('i').className = 'w-6 h-6 mr-2 text-rose-600';
            }
            updateCategories();
        }

        function updateCategories() {
            const type = document.getElementById('inp-type').value;
            const catSelect = document.getElementById('inp-category');
            let cats = state.categories || [];
            if (cats.length > 0 && typeof cats[0] === 'object' && cats[0].type) {
                cats = cats.filter(c => c.type === type || c.type === 'both' || !c.type);
            }
            catSelect.innerHTML = cats.map(c => {
                const val = typeof c === 'object' ? c.name : c;
                return `<option value="${val}">${val}</option>`;
            }).join('');
        }

        function cancelEdit() {
            document.getElementById('entry-form').reset();
            document.getElementById('inp-id').value = '';
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('edit-mode-indicator').classList.add('hidden');
            document.getElementById('form-title').innerText = 'æ–°å¢ç´€éŒ„';
            document.getElementById('btn-submit').innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜ä¸¦åˆ—å°';
            const now = new Date();
            const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            document.getElementById('inp-date').value = dateStr;
            setType('expense');
            lucide.createIcons();
        }

        function startEdit(id) {
            const t = state.transactions.find(x => String(x.id) === String(id));
            if(!t) return;
            switchTab('entry');
            document.getElementById('inp-id').value = t.id;
            document.getElementById('inp-date').value = (t.date || '').split('T')[0];
            document.getElementById('inp-amount').value = t.amount;
            document.getElementById('inp-summary').value = t.summary;
            document.getElementById('inp-project').value = t.projectId;
            document.getElementById('inp-payee').value = t.payee || '';
            document.getElementById('inp-bank-account').value = t.bankAccount || '';
            document.getElementById('inp-note').value = t.note || '';
            setType(t.type); 
            setTimeout(() => {
                document.getElementById('inp-category').value = t.category;
            }, 0);
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('form-title').innerText = 'ä¿®æ”¹ç´€éŒ„';
            document.getElementById('btn-submit').innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> æ›´æ–°ç´€éŒ„';
            lucide.createIcons();
        }
        
        function digitToChinese(n) {
            const fraction = ['è§’', 'åˆ†'];
            const digit = ['é›¶', 'å£¹', 'è²³', 'åƒ', 'è‚†', 'ä¼', 'é™¸', 'æŸ’', 'æŒ', 'ç–'];
            const unit = [['å…ƒ', 'è¬', 'å„„'], ['', 'æ‹¾', 'ä½°', 'ä»Ÿ']];
            let num = Math.abs(n);
            let s = '';
            for (let i = 0; i < fraction.length; i++) {
                s += (digit[Math.floor(num * 10 * Math.pow(10, i)) % 10] + fraction[i]).replace(/é›¶./, '');
            }
            s = s || 'æ•´';
            num = Math.floor(num);
            for (let i = 0; i < unit[0].length && num > 0; i++) {
                let p = '';
                for (let j = 0; j < unit[1].length && num > 0; j++) {
                    p = digit[num % 10] + unit[1][j] + p;
                    num = Math.floor(num / 10);
                }
                s = p.replace(/(é›¶.)*é›¶$/, '').replace(/^$/, 'é›¶') + unit[0][i] + s;
            }
            return s.replace(/(é›¶.)*é›¶å…ƒ/, 'å…ƒ').replace(/(é›¶.)+/g, 'é›¶').replace(/^æ•´$/, 'é›¶å…ƒæ•´');
        }

        // --- Global State ---
        const FIXED_API_URL = "https://script.google.com/macros/s/AKfycbwE8Z-8a3DwDnPBRQh2NbOv3D2SpWUctxyKz11POLewQsv1TGSm4YS3fvBbpX9YplZE/exec";

        let state = { 
            apiUrl: FIXED_API_URL, 
            transactions: [], 
            projects: [], 
            categories: [], 
            users: [], 
            currentUser: null,
            currentPage: 1,
            itemsPerPage: 15
        };
        let toastTimeout;
        window.firebaseUser = null;

        window.onload = () => {
            lucide.createIcons();
            const now = new Date();
            const dateStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            document.getElementById('inp-date').value = dateStr;
        };

        function autoPadAccount(el) {
            let val = el.value.trim();
            if (val.length > 0 && val.length < 14 && /^\d+$/.test(val)) {
                el.value = val.padStart(14, '0');
            }
        }

        async function apiCall(payload) {
            const res = await fetch(state.apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error(`Server Error: ${res.status}`);
            const data = await res.json();
            if (data.status === 'error') throw new Error(data.message || 'æ“ä½œå¤±æ•—');
            return data;
        }

        async function fetchData() {
            showLoading(true);
            try {
                const res = await fetch(state.apiUrl); 
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                
                state.projects = data.projects || []; 
                state.transactions = data.transactions || [];
                state.categories = data.categories || []; 
                state.users = data.users || [];
                
                if (window.firebaseUser) {
                    const email = window.firebaseUser.email;
                    const userRecord = state.users.find(u => u.id.toLowerCase() === email.toLowerCase());
                    
                    if (userRecord) {
                        state.currentUser = userRecord;
                        showToast(`æ­¡è¿å›ä¾† ${userRecord.name}`);
                        document.getElementById('user-display').innerText = `${userRecord.name} (${userRecord.role})`;
                        document.getElementById('navbar').classList.replace('bg-slate-700', 'bg-teal-700');
                        updateUI();
                        switchTab('dashboard');
                    } else {
                        // å³ä¾¿æ˜¯è¨ªå®¢ï¼Œä¹Ÿå¿…é ˆé€šéç¶²åŸŸæª¢æŸ¥ (å› ç‚º onAuthStateChanged æœƒæ“‹æ‰)
                        // ä½†å¦‚æœ GAS Users æ²’è³‡æ–™ï¼Œé€™è£¡æœƒè®Šæˆè¨ªå®¢æ¨¡å¼
                        state.currentUser = { id: email, name: 'æ–°æˆå“¡', role: 'guest' };
                        document.getElementById('user-display').innerText = 'æ–°æˆå“¡';
                        updateUI();
                        switchTab('dashboard');
                        showToast('æ‚¨çš„å¸³è™Ÿæœªåœ¨ç³»çµ±åå–®ä¸­ï¼Œæ¬Šé™å—é™', 'error');
                    }
                }
            } catch (e) { 
                console.error(e);
                showToast('é€£ç·šå¤±æ•—: ' + e.message, 'error'); 
            } finally { 
                showLoading(false); 
            }
        }

        function downloadCurrentPDF() {
            const element = document.getElementById('print-content');
            const isLandscape = document.getElementById('print-content').classList.contains('landscape-content');
            const opt = {
                margin:       [5, 5, 5, 5], 
                filename:     `onanip_report_${new Date().toISOString().slice(0,10)}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: isLandscape ? 'landscape' : 'portrait' }
            };
            showLoading(true);
            html2pdf().set(opt).from(element).save().then(() => {
                showLoading(false);
                showToast('ä¸‹è¼‰æˆåŠŸ');
            }).catch(err => {
                showLoading(false);
                showToast('PDF ç”¢ç”Ÿå¤±æ•—', 'error');
                console.error(err);
            });
        }

        function toggleReportDate() {
            const isFull = document.getElementById('rpt-full-year').checked;
            const mInput = document.getElementById('rpt-month');
            mInput.disabled = isFull;
            if (isFull) mInput.classList.add('bg-slate-100', 'text-slate-400');
            else mInput.classList.remove('bg-slate-100', 'text-slate-400');
        }

        function openReportModal() {
            const role = (state.currentUser?.role || '').toLowerCase();
            const isAdminOrAccountant = ['admin', 'accountant'].includes(role);
            const availableProjects = state.projects.filter(p => {
                if (isAdminOrAccountant) return true;
                return !isProjectClosed(p);
            });
            const sel = document.getElementById('rpt-project');
            sel.innerHTML = '<option value="ALL">å…¨éƒ¨è¨ˆç•« (All Projects)</option>' + availableProjects.map(p=>`<option value="${p.id}">${p.name}${isProjectClosed(p) ? ' (å·²é—œå¸³)' : ''}</option>`).join('');
            document.getElementById('rpt-month').value = new Date().toISOString().slice(0, 7);
            document.getElementById('rpt-full-year').checked = false;
            toggleReportDate();
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function isProjectClosed(project) {
            return String(project.status) === 'CLOSED' || String(project.isClosed).toUpperCase() === 'TRUE';
        }

        async function toggleProjectStatus(id, newStatus) {
            if(!confirm(`ç¢ºå®šè¦å°‡æ­¤è¨ˆç•«æ¨™è¨˜ç‚º${newStatus === 'CLOSED' ? 'ã€é—œå¸³ã€‘' : 'ã€é–‹å•Ÿã€‘'}å—ï¼Ÿ`)) return;
            if(!state.currentUser) return showToast('è«‹å…ˆç™»å…¥', 'error');
            const p = state.projects.find(x => String(x.id) === String(id));
            const oldStatus = p ? p.status : '';
            if(p) { p.status = newStatus; updateUI(); }
            try {
                await apiCall({ 
                    action: 'updateProjectStatus', 
                    id: id, 
                    status: newStatus,
                    role: state.currentUser.role 
                });
                showToast(`è¨ˆç•«å·²${newStatus === 'CLOSED' ? 'é—œå¸³' : 'é–‹å•Ÿ'}`);
            } catch(err) {
                if(p) p.status = oldStatus; 
                updateUI();
                showToast('æ›´æ–°å¤±æ•—: ' + err.message, 'error');
            }
        }

        function generateReport() {
            const projId = document.getElementById('rpt-project').value;
            const isFullYear = document.getElementById('rpt-full-year').checked;
            const monthStr = isFullYear ? '' : document.getElementById('rpt-month').value;
            const type = document.querySelector('input[name="rpt-type"]:checked').value;
            
            let filtered = state.transactions.filter(t => {
                const safeDate = (t.date || '').split('T')[0];
                return ((projId==='ALL') || (String(t.projectId)===String(projId))) && (!monthStr || safeDate.startsWith(monthStr));
            });
            filtered.sort((a,b) => new Date(a.date) - new Date(b.date));

            const projName = projId === 'ALL' ? 'å…¨éƒ¨è¨ˆç•«' : (state.projects.find(p=>String(p.id)===String(projId))?.name || projId);
            const rptName = type==='journal'?'æ—¥è¨˜å¸³':type==='ledger'?'åˆ†é¡å¸³':'æ”¶æ”¯æœˆå ±è¡¨';
            
            let totalBudget = 0;
            let totalUsedAllTime = 0;

            if (projId === 'ALL') {
                totalBudget = state.projects.reduce((sum, p) => sum + (Number(p.budget) || 0), 0);
                totalUsedAllTime = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            } else {
                const p = state.projects.find(x => String(x.id) === String(projId));
                totalBudget = Number(p ? p.budget : 0);
                totalUsedAllTime = state.transactions
                    .filter(t => String(t.projectId) === String(projId) && t.type === 'expense')
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            }
            const remainingBudget = totalBudget - totalUsedAllTime;
            
            const contentDiv = document.getElementById('print-content');
            const isLandscape = type === 'ledger';
            contentDiv.className = isLandscape ? 'landscape-content bg-white p-4 pdf-content mx-auto' : 'bg-white p-4 pdf-content mx-auto';
            contentDiv.style.width = isLandscape ? '287mm' : '200mm'; 

            let html = `<div class="text-center mb-4"><h1 class="text-2xl font-bold border-b-2 border-black inline-block pb-1">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1><h2 class="text-xl font-bold mt-2">${rptName}</h2><p class="text-sm mt-1">ç¯„åœï¼š${projName} | æœŸé–“ï¼š${isFullYear ? 'å…¨å¹´åº¦' : monthStr}</p></div>`;

            if (type === 'journal' || type === 'ledger') {
                html += `<div class="budget-info">
                    <div class="budget-item"><div class="budget-label">ç¸½é ç®—</div><div class="budget-value text-slate-700">$${totalBudget.toLocaleString()}</div></div>
                    <div class="budget-item"><div class="budget-label">ç´¯è¨ˆæ”¯å‡º (è‡³ä»Šæ—¥)</div><div class="budget-value text-rose-600">$${totalUsedAllTime.toLocaleString()}</div></div>
                    <div class="budget-item"><div class="budget-label">é ç®—é¤˜é¡</div><div class="budget-value ${remainingBudget >= 0 ? 'text-emerald-600' : 'text-red-600'}">$${remainingBudget.toLocaleString()}</div></div>
                </div>`;
            }

            if (filtered.length === 0) html += '<p class="text-center py-10 text-slate-400">æŸ¥ç„¡è³‡æ–™</p>';
            else if (type === 'journal') {
                html += `<table class="preview-table"><thead><tr><th>æ—¥æœŸ</th><th>è¨ˆç•«</th><th>ç§‘ç›®</th><th>æ‘˜è¦</th><th class="text-right">æ”¶å…¥</th><th class="text-right">æ”¯å‡º</th></tr></thead><tbody>`;
                let sIn=0, sOut=0;
                filtered.forEach(t => {
                    const isInc = t.type === 'income'; const amt = Number(t.amount); if(isInc)sIn+=amt; else sOut+=amt;
                    const pName = state.projects.find(p=>String(p.id)===String(t.projectId))?.name || '';
                    const safeDate = (t.date || '').split('T')[0];
                    html += `<tr><td>${safeDate}</td><td>${pName}</td><td>${t.category}</td><td>${t.summary}</td><td class="amount-col">${isInc?amt.toLocaleString():''}</td><td class="amount-col">${!isInc?amt.toLocaleString():''}</td></tr>`;
                });
                html += `<tr style="font-weight:bold;background:#f8fafc"><td colspan="4" class="text-right">åˆè¨ˆï¼š</td><td class="amount-col">${sIn.toLocaleString()}</td><td class="amount-col">${sOut.toLocaleString()}</td></tr></tbody></table><div class="text-right font-bold mt-2">æœŸé–“çµé¤˜ï¼š$${(sIn-sOut).toLocaleString()}</div>`;
            } else if (type === 'ledger') {
                const groups = {}; filtered.forEach(t => { if(!groups[t.category]) groups[t.category]=[]; groups[t.category].push(t); });
                for(const cat in groups) {
                    const txs = groups[cat]; const total = txs.reduce((a,c)=>a+Number(c.amount),0);
                    html += `<h3 class="font-bold mt-6 mb-2 border-l-4 border-slate-500 pl-2 bg-slate-100 p-1">${cat}</h3><table class="preview-table"><thead><tr><th>æ—¥æœŸ</th><th>æ‘˜è¦</th><th>è¨ˆç•«</th><th class="text-right">é‡‘é¡</th></tr></thead><tbody>`;
                    txs.forEach(t => { const safeDate = (t.date || '').split('T')[0]; html += `<tr><td>${safeDate}</td><td>${t.summary}</td><td>${state.projects.find(p=>String(p.id)===String(t.projectId))?.name||''}</td><td class="amount-col">${Number(t.amount).toLocaleString()}</td></tr>`; });
                    html += `<tr style="font-weight:bold"><td colspan="3" class="text-right">å°è¨ˆï¼š</td><td class="amount-col">$${total.toLocaleString()}</td></tr></tbody></table>`;
                }
            } else {
                const iMap={}, eMap={}; filtered.forEach(t=>{ const a=Number(t.amount); if(t.type==='income') iMap[t.category]=(iMap[t.category]||0)+a; else eMap[t.category]=(eMap[t.category]||0)+a; });
                const tI = Object.values(iMap).reduce((a,b)=>a+b,0); const tE = Object.values(eMap).reduce((a,b)=>a+b,0);
                html += `<div style="display:flex;gap:20px;"><div style="flex:1"><table class="preview-table"><thead><tr><th colspan="2" style="text-align:center;background:#dcfce7">æ”¶å…¥</th></tr></thead><tbody>${Object.entries(iMap).map(([k,v])=>`<tr><td>${k}</td><td class="amount-col">${v.toLocaleString()}</td></tr>`).join('')}<tr style="font-weight:bold"><td>åˆè¨ˆ</td><td class="amount-col">${tI.toLocaleString()}</td></tr></tbody></table></div><div style="flex:1"><table class="preview-table"><thead><tr><th colspan="2" style="text-align:center;background:#fee2e2">æ”¯å‡º</th></tr></thead><tbody>${Object.entries(eMap).map(([k,v])=>`<tr><td>${k}</td><td class="amount-col">${v.toLocaleString()}</td></tr>`).join('')}<tr style="font-weight:bold"><td>åˆè¨ˆ</td><td class="amount-col">${tE.toLocaleString()}</td></tr></tbody></table></div></div><div class="text-center font-bold text-xl mt-4 border p-4 bg-slate-50">æœ¬æœŸçµé¤˜ï¼š$${(tI-tE).toLocaleString()}</div>`;
            }

            html += `<table class="sign-table" style="width:100%; border-collapse:collapse; margin-top:30px;">
                <tr><th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">ç†äº‹é•·</th><th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">ç¸½å¹¹äº‹</th><th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">æœƒè¨ˆ</th><th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">å‡ºç´</th></tr>
                <tr><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td></tr>
            </table>`;
            
            contentDiv.innerHTML = html;
            document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('print-modal').classList.remove('hidden');
        }

        function openVoucher(id) {
            const transaction = state.transactions.find(t => String(t.id) === String(id));
            if (!transaction) return showToast('æ‰¾ä¸åˆ°è©²ç­†è³‡æ–™', 'error');

            const proj = state.projects.find(p => String(p.id) === String(transaction.projectId)) || {name: 'æœªçŸ¥è¨ˆç•«', id: 'N/A'};
            const safeDate = (transaction.date || '').split('T')[0];
            const contentDiv = document.getElementById('print-content');
            contentDiv.className = 'bg-white p-4 pdf-content mx-auto'; 
            contentDiv.style.width = '200mm'; 
            let bankAcc = String(transaction.bankAccount || '');
            if (bankAcc.length > 0 && bankAcc.length < 14) bankAcc = bankAcc.padStart(14, '0');

            const content = `
                <div class="text-center mb-6"><h1 class="text-2xl font-bold tracking-widest mb-2 border-b-2 border-black inline-block pb-1">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1><h2 class="text-xl font-bold mt-2">æ”¯ç”¨å–®æ“šé»è²¼æ†‘è­‰ç”¨ç´™</h2></div>
                <div class="flex justify-between mb-2 font-mono text-sm"><div><span class="font-bold">è¨ˆç•«ï¼š</span>${proj.id}</div><div><span class="font-bold">ç·¨è™Ÿï¼š</span>${String(transaction.id).slice(-6)}</div></div>
                <table class="preview-table mb-4 text-sm">
                    <tr><th>è¨ˆç•«åç¨±</th><td colspan="3">${proj.name}</td><th>ç”³è«‹æ—¥æœŸ</th><td>${safeDate}</td></tr>
                    <tr><th width="15%">ç§‘ç›®</th><td width="25%">${transaction.category}</td><th width="15%">å—æ¬¾äºº</th><td width="25%">${transaction.payee || ''}</td><th width="10%">é‡‘é¡</th><td class="font-bold font-mono text-lg">$${Number(transaction.amount).toLocaleString()}</td></tr>
                    <tr><th>åŒ¯æ¬¾å¸³è™Ÿ</th><td colspan="5">${bankAcc}</td></tr>
                    <tr><th>æ‘˜è¦</th><td colspan="5" class="h-16 align-top">${transaction.summary}</td></tr>
                    <tr><th>å‚™è¨»</th><td colspan="5">${transaction.note || ''}</td></tr>
                </table>
                <div class="attachment-area">æ†‘ è­‰ é» è²¼ è™•</div>
                <div class="text-xs mb-1">åˆè¨ˆæ–°å°å¹£ï¼š<span class="text-base ml-2">${digitToChinese(transaction.amount)}</span></div>
                <table class="preview-table text-center" style="width:100%; border-collapse:collapse;">
                    <tr><th style="width:20%; border:1px solid #000;">ç†äº‹é•·</th><th style="width:20%; border:1px solid #000;">ç¸½å¹¹äº‹</th><th style="width:20%; border:1px solid #000;">æœƒè¨ˆ</th><th style="width:20%; border:1px solid #000;">é©—æ”¶è­‰æ˜</th><th style="width:20%; border:1px solid #000;">ç¶“è¾¦äºº</th></tr>
                    <tr><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td><td style="height:80px; border:1px solid #000;"></td></tr>
                </table>
            `;
            contentDiv.innerHTML = content;
            document.getElementById('print-modal').classList.remove('hidden');
        }

        document.getElementById('entry-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            const isEdit=document.getElementById('inp-id').value!==""; 
            const btn=document.getElementById('btn-submit'); 
            btn.disabled=true; 
            let rawBankAcc = document.getElementById('inp-bank-account').value.trim();
            if(rawBankAcc && rawBankAcc.length > 0 && rawBankAcc.length < 14 && /^\d+$/.test(rawBankAcc)) {
                rawBankAcc = rawBankAcc.padStart(14, '0');
            }
            const formData={ 
                action: isEdit?'edit':'add', 
                id: isEdit?document.getElementById('inp-id').value:Date.now().toString(), 
                date:document.getElementById('inp-date').value, 
                type:document.getElementById('inp-type').value, 
                projectId:document.getElementById('inp-project').value, 
                category:document.getElementById('inp-category').value, 
                summary:document.getElementById('inp-summary').value, 
                amount:document.getElementById('inp-amount').value, 
                payee:document.getElementById('inp-payee').value, 
                bankAccount: rawBankAcc, 
                note:document.getElementById('inp-note').value, 
                createdBy:state.currentUser.id,
                role: state.currentUser.role 
            }; 
            try { 
                showLoading(true);
                await apiCall(formData);
                if(isEdit){ 
                    const idx=state.transactions.findIndex(t=>t.id==formData.id); 
                    if(idx!==-1){ 
                        formData.accountantApproved = state.transactions[idx].accountantApproved;
                        formData.isPaid = state.transactions[idx].isPaid;
                        formData.createdBy=state.transactions[idx].createdBy; 
                        state.transactions[idx]=formData; 
                    } 
                } else { 
                    formData.accountantApproved = 'FALSE';
                    formData.isPaid = 'FALSE';
                    state.transactions.unshift(formData); 
                } 
                updateUI(); 
                cancelEdit(); 
                if(!isEdit && formData.type==='expense'){ 
                    openVoucher(formData.id); 
                    showToast('å„²å­˜æˆåŠŸï¼å¯ä¸‹è¼‰ PDF'); 
                } else { 
                    showToast('å„²å­˜æˆåŠŸ'); 
                } 
            } catch(err){ 
                showToast('å„²å­˜å¤±æ•—ï¼š' + err.message, 'error'); 
            } finally { 
                btn.disabled=false; 
                showLoading(false);
            } 
        };

        async function approveItem(id) {
            if(!confirm('ç¢ºå®šæ ¸å‡†æ­¤æ¬¾é …ï¼Ÿæ ¸å‡†å¾Œå°‡ç„¡æ³•ä¿®æ”¹ã€‚')) return;
            const t = state.transactions.find(x => String(x.id) === String(id));
            if(t) { t.accountantApproved = 'TRUE'; updateUI(); }
            try { await apiCall({action: 'approve', id: id}); showToast('å·²æ ¸å‡†'); } 
            catch(err) { if(t) t.accountantApproved = 'FALSE'; updateUI(); showToast('æ ¸å‡†å¤±æ•—: ' + err.message, 'error'); }
        }

        async function payItem(id) {
            if(!confirm('ç¢ºèªå·²å®ŒæˆåŒ¯æ¬¾ï¼Ÿ')) return;
            const t = state.transactions.find(x => String(x.id) === String(id));
            if(t) { t.isPaid = 'TRUE'; updateUI(); }
            try { await apiCall({action: 'pay', id: id}); showToast('åŒ¯æ¬¾ç‹€æ…‹å·²æ›´æ–°'); } 
            catch(err) { if(t) t.isPaid = 'FALSE'; updateUI(); showToast('æ›´æ–°å¤±æ•—: ' + err.message, 'error'); }
        }

        async function deleteItem(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
            const originalList = [...state.transactions];
            state.transactions = state.transactions.filter(t=>String(t.id)!==String(id));
            updateUI();
            try { await apiCall({action:'delete', id:id, role: state.currentUser.role}); showToast('åˆªé™¤æˆåŠŸ'); } 
            catch(err) { state.transactions = originalList; updateUI(); showToast('åˆªé™¤å¤±æ•—ï¼š' + err.message, 'error'); }
        }

        function nextPage() {
            const totalPages = Math.ceil(state.transactions.length / state.itemsPerPage);
            if (state.currentPage < totalPages) { state.currentPage++; updateUI(); }
        }

        function prevPage() {
            if (state.currentPage > 1) { state.currentPage--; updateUI(); }
        }

        function updateUI() { 
            if(!state.currentUser) return; 
            const user=state.currentUser; 
            const role = (user.role || '').toLowerCase().trim(); 
            const isAdmin = role === 'admin'; 
            const isAccountant = role === 'accountant' || isAdmin;
            const isTreasurer = role === 'treasurer' || isAdmin;

            const btnIncome = document.getElementById('btn-income');
            if (['admin', 'accountant', 'treasurer'].includes(role)) {
                btnIncome.classList.remove('hidden');
            } else {
                btnIncome.classList.add('hidden');
                if (document.getElementById('inp-type').value === 'income') setType('expense');
            }

            const inc=state.transactions.filter(t=>t.type==='income').reduce((a,c)=>a+(+c.amount||0),0); 
            const exp=state.transactions.filter(t=>t.type==='expense').reduce((a,c)=>a+(+c.amount||0),0); 
            document.getElementById('total-income').innerText='$'+inc.toLocaleString(); 
            document.getElementById('total-expense').innerText='$'+exp.toLocaleString(); 
            
            const pStats=document.getElementById('project-stats'); 
            pStats.innerHTML=''; 
            const pList=document.getElementById('projects-list-content'); 
            pList.innerHTML=''; 
            
            state.projects.forEach(p=>{ 
                const closed = isProjectClosed(p);
                const used=state.transactions.filter(t=>String(t.projectId)===String(p.id)&&t.type==='expense').reduce((a,c)=>a+(+c.amount||0),0); 
                const pct=Math.min(Math.round(used/(p.budget||1)*100)||0,100); 
                
                if (!closed || isAccountant) {
                    pStats.innerHTML+=`<div class="mb-3"><div class="flex justify-between text-sm mb-1"><span>${p.name}${closed?' (å·²é—œå¸³)':''}</span><span class="text-slate-500">$${used.toLocaleString()} / ${(p.budget||0).toLocaleString()}</span></div><div class="bg-slate-100 rounded-full h-2"><div class="h-2 rounded-full ${closed ? 'bg-slate-400' : (pct>90?'bg-rose-500':pct>70?'bg-amber-400':'bg-teal-500')}" style="width:${pct}%"></div></div></div>`; 
                }

                let actionBtn = '';
                if (isAccountant) {
                    if (closed) {
                        actionBtn = `<button onclick="toggleProjectStatus('${p.id}', 'OPEN')" class="text-xs bg-slate-200 hover:bg-slate-300 text-slate-700 px-3 py-1 rounded font-bold border border-slate-300">é‡å•Ÿ</button>`;
                    } else {
                        actionBtn = `<button onclick="toggleProjectStatus('${p.id}', 'CLOSED')" class="text-xs bg-white hover:bg-slate-50 text-rose-500 px-3 py-1 rounded font-bold border border-rose-200 flex items-center"><i data-lucide="lock" class="w-3 h-3 mr-1"></i>é—œå¸³</button>`;
                    }
                } else if (closed) {
                    actionBtn = `<span class="text-xs bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold border border-slate-200">å·²é—œå¸³</span>`;
                }

                pList.innerHTML+=`
                    <div class="border border-slate-200 rounded-lg p-3 flex justify-between items-center ${closed ? 'project-closed' : ''}">
                        <div>
                            <div class="font-bold text-slate-700 flex items-center">
                                ${p.name}
                                ${closed ? '<span class="ml-2 text-xs bg-slate-200 text-slate-600 px-1.5 rounded">Closed</span>' : ''}
                            </div>
                            <div class="text-xs text-slate-500">${p.funder||''}</div>
                        </div>
                        <div class="text-right flex items-center space-x-3">
                            <div class="font-mono font-bold ${closed?'text-slate-500':'text-teal-700'}">$${(p.budget||0).toLocaleString()}</div>
                            ${actionBtn}
                        </div>
                    </div>`; 
            }); 
            
            const pSelect=document.getElementById('inp-project'); 
            const savedP=pSelect.value; 
            const activeProjects = state.projects.filter(p => isAccountant || !isProjectClosed(p));
            pSelect.innerHTML=activeProjects.map(p=>`<option value="${p.id}">${p.name}${isProjectClosed(p) ? ' (å·²é—œå¸³)' : ''}</option>`).join(''); 
            if(savedP) pSelect.value=savedP; 
            updateCategories(); 
            
            const sortedTransactions = state.transactions
                .filter(t => {
                    if (isAccountant) return true;
                    const proj = state.projects.find(p => String(p.id) === String(t.projectId));
                    return proj && !isProjectClosed(proj);
                })
                .sort((a,b) => {
                    const dA = new Date(a.date).getTime() || 0;
                    const dB = new Date(b.date).getTime() || 0;
                    if (dB !== dA) return dB - dA; 
                    return (Number(b.id) || 0) - (Number(a.id) || 0);
                });
            
            const totalPages = Math.ceil(sortedTransactions.length / state.itemsPerPage);
            if (state.currentPage > totalPages && totalPages > 0) state.currentPage = totalPages;
            if (state.currentPage === 0 && totalPages > 0) state.currentPage = 1; 
            
            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const pageItems = sortedTransactions.slice(startIndex, endIndex);

            const tbody=document.getElementById('list-body'); 
            if (sortedTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center py-10 text-slate-400">å°šç„¡è³‡æ–™</td></tr>';
            } else {
                tbody.innerHTML=pageItems.map(t=>{ 
                    const proj=state.projects.find(p=>String(p.id)===String(t.projectId));
                    const projName=proj?.name||'(æœªçŸ¥)'; 
                    const safeDate=(t.date||'').split('T')[0]; 
                    const isClosed = proj && isProjectClosed(proj);
                    const isApproved = String(t.accountantApproved).toUpperCase() === 'TRUE';
                    const isPaid = String(t.isPaid).toUpperCase() === 'TRUE';
                    const isLocked = isApproved || isPaid || isClosed; 
                    const canModify = (isAdmin) || (!isLocked && (isAccountant || String(t.createdBy) === String(user.id)));

                    let treasurerInfo = '';
                    if ((isTreasurer || isAdmin) && t.type === 'expense') {
                        let acc = String(t.bankAccount || '');
                        if(acc.length > 0 && acc.length < 14 && /^\d+$/.test(acc)) acc = acc.padStart(14, '0');
                        treasurerInfo = `<div class="text-xs text-indigo-600 mt-1 font-mono bg-indigo-50 p-1 rounded inline-block"><span class="font-bold">å—æ¬¾:</span> ${t.payee || '-'} <span class="font-bold ml-2">å¸³è™Ÿ:</span> ${acc || '-'}</div>`;
                    }

                    let actionBtns = '';
                    let statusBadge = '';
                    if (t.type === 'expense') {
                        if (isPaid) statusBadge = `<span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded-full font-bold">åŒ¯æ¬¾å®Œæˆ</span>`;
                        else if (isApproved) statusBadge = `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-bold">å¾…åŒ¯æ¬¾</span>`;
                        else statusBadge = `<span class="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full font-bold">å¾…æ ¸å‡†</span>`;
                    }
                    if (isClosed) statusBadge += `<span class="ml-1 bg-slate-200 text-slate-600 text-xs px-2 py-1 rounded-full font-bold">é—œå¸³</span>`;

                    if (t.type === 'expense') actionBtns += `<button onclick="openVoucher('${t.id}')" class="p-1.5 text-slate-400 hover:text-teal-600 hover:bg-teal-50 rounded" title="åˆ—å°å–®æ“š"><i data-lucide="printer" class="w-4 h-4"></i></button>`;

                    if (canModify && !isClosed) { 
                        actionBtns += `<button onclick="startEdit('${t.id}')" class="p-1.5 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded" title="ä¿®æ”¹"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="deleteItem('${t.id}')" class="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded" title="åˆªé™¤"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`;
                    } else if (isLocked || isClosed) {
                        actionBtns += `<span class="p-1.5 text-slate-300" title="å·²é–å®š/é—œå¸³"><i data-lucide="lock" class="w-4 h-4"></i></span>`;
                    }

                    if (isAccountant && !isApproved && t.type === 'expense' && !isClosed) actionBtns += `<button onclick="approveItem('${t.id}')" class="ml-1 px-2 py-1 bg-indigo-50 text-indigo-600 text-xs rounded border border-indigo-200 hover:bg-indigo-100 font-bold">æ ¸å‡†</button>`;
                    if (isTreasurer && isApproved && !isPaid && t.type === 'expense' && !isClosed) actionBtns += `<button onclick="payItem('${t.id}')" class="ml-1 px-2 py-1 bg-emerald-50 text-emerald-600 text-xs rounded border border-emerald-200 hover:bg-emerald-100 font-bold">åŒ¯æ¬¾</button>`;

                    return `<tr class="hover:bg-slate-50 group"><td class="px-4 py-3 align-top"><div class="flex items-center space-x-2 mb-1"><span class="font-mono text-slate-500 text-xs">${safeDate} <span class="text-slate-300">#${String(t.id).slice(-6)}</span></span>${statusBadge}</div><div class="text-xs text-slate-400 truncate max-w-[100px]">${projName}</div><div class="text-sm font-medium text-slate-800">${t.summary}</div>${treasurerInfo}</td><td class="px-4 py-3 text-right align-top"><div class="font-mono font-bold ${t.type==='income'?'text-emerald-600':'text-rose-600'}">${t.type==='income'?'+':'-'}${Number(t.amount).toLocaleString()}</div></td><td class="px-4 py-3 text-center align-top"><div class="flex justify-center items-center space-x-1 flex-wrap gap-y-1">${actionBtns}</div></td></tr>`; 
                }).join(''); 
            }
            
            document.getElementById('page-info').innerText = `ç¬¬ ${state.currentPage} / ${totalPages || 1} é `;
            document.getElementById('btn-prev-page').disabled = state.currentPage <= 1;
            document.getElementById('btn-next-page').disabled = state.currentPage >= totalPages;

            lucide.createIcons(); 
        }
    </script>

    <!-- Firebase Integration Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // ğŸ”´ è«‹åœ¨é€™è£¡è²¼ä¸Šæ‚¨çš„ Firebase è¨­å®š (å¾ Firebase æ§åˆ¶å° -> å°ˆæ¡ˆè¨­å®š -> ä¸€èˆ¬ -> æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ ä¸‹æ–¹è¤‡è£½)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
      apiKey: "AIzaSyAS-zev6s404Osu7v2H93Z2IpXAUqkKn6A",
      authDomain: "docs-89031.firebaseapp.com",
      projectId: "docs-89031",
      storageBucket: "docs-89031.firebasestorage.app",
      messagingSenderId: "321571628998",
      appId: "1:321571628998:web:e4be3b3fba9aafa1a234c7",
      measurementId: "G-YSNN9LDVNF"
        };

        let app, auth;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šç¢¼ã€‚", e);
        }

        window.firebaseUser = null;
        const provider = new GoogleAuthProvider();

        window.firebaseLogin = async () => {
            if (!auth) return alert("Firebase æœªæ­£ç¢ºè¨­å®š");
            try {
                showLoading(true);
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // ğŸŸ¢ ç¶²åŸŸæª¢æŸ¥ (Domain Check)
                if (!user.email.endsWith('@onanip.org')) {
                    await signOut(auth);
                    showLoading(false);
                    document.getElementById('login-msg').innerText = "ç™»å…¥å¤±æ•—ï¼šæœ¬ç³»çµ±åƒ…é™ @onanip.org å¸³è™Ÿä½¿ç”¨";
                    document.getElementById('login-msg').classList.remove('hidden');
                    return;
                }
                
                // é€šéæª¢æŸ¥ï¼ŒonAuthStateChanged æœƒæ¥æ‰‹è™•ç†å¾ŒçºŒ
            } catch (error) {
                showLoading(false);
                console.error(error);
                let msg = "ç™»å…¥å¤±æ•—: " + error.message;
                document.getElementById('login-msg').innerText = msg;
                document.getElementById('login-msg').classList.remove('hidden');
            }
        };

        window.handleLogout = async () => {
            if(!confirm('ç¢ºå®šè¦ç™»å‡ºï¼Ÿ')) return;
            try {
                showLoading(true);
                await signOut(auth);
            } catch (error) {
                console.error(error);
                showLoading(false);
            }
        };

        if (auth) {
            onAuthStateChanged(auth, async (user) => {
                window.firebaseUser = user;
                if (user) {
                    // ğŸŸ¢ é›™é‡æª¢æŸ¥ï¼šé˜²æ­¢å·²ç™»å…¥çš„éçµ„ç¹”å¸³è™Ÿé€²å…¥
                    if (!user.email.endsWith('@onanip.org')) {
                        await signOut(auth);
                        document.getElementById('login-msg').innerText = "æœ¬ç³»çµ±åƒ…é™ @onanip.org å¸³è™Ÿä½¿ç”¨";
                        document.getElementById('login-msg').classList.remove('hidden');
                        document.getElementById('login-overlay').classList.remove('hidden');
                        showLoading(false);
                        return;
                    }

                    document.getElementById('login-overlay').classList.add('hidden');
                    fetchData(); 
                } else {
                    state.currentUser = null;
                    document.getElementById('login-msg').classList.add('hidden');
                    document.getElementById('login-overlay').classList.remove('hidden');
                    document.getElementById('navbar').classList.replace('bg-teal-700','bg-slate-700');
                    document.getElementById('user-display').innerText = 'æœªç™»å…¥';
                    
                    switchTab('dashboard'); 
                    showLoading(false);
                }
            });
        }
    </script>
</body>
</html>
