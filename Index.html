<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ - æœƒè¨ˆç³»çµ±</title>
    <!-- å¼•å…¥ Tailwind CSS (ç¾åŒ–ä»‹é¢) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Lucide Icons (åœ–ç¤º) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-20 md:pb-0">

    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav id="navbar" class="bg-slate-700 text-white shadow-lg sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-1.5 rounded-full text-slate-700">
                    <i data-lucide="wallet" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide hidden md:block">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1>
                    <h1 class="text-lg font-bold tracking-wide md:hidden">'onanip æœƒè¨ˆ</h1>
                    <div id="connection-status" class="flex items-center space-x-2 text-xs opacity-90 text-orange-300">
                        <i data-lucide="alert-circle" class="w-3 h-3"></i>
                        <span>æ¨¡æ“¬æ¨¡å¼</span>
                    </div>
                </div>
            </div>
            <button onclick="switchTab('settings')" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </nav>

    <!-- é€šçŸ¥è¨Šæ¯ (Toast) -->
    <div id="toast" class="fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl z-50 text-white hidden transition-all duration-300 transform translate-y-[-20px] opacity-0">
        <span id="toast-msg">è¨Šæ¯å…§å®¹</span>
    </div>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-40 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <i data-lucide="loader-2" class="w-10 h-10 animate-spin text-teal-600 mb-2"></i>
        <p class="text-slate-500 font-medium">è³‡æ–™åŒæ­¥ä¸­...</p>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-5xl mx-auto px-4 py-6">

        <!-- 1. å„€è¡¨æ¿ (Dashboard) -->
        <div id="view-dashboard" class="view-section fade-in">
            <!-- ç¸½è¨ˆå¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¶å…¥</p>
                    <p id="dash-total-income" class="text-2xl font-bold text-slate-800">$0</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-500">
                    <p class="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¯å‡º</p>
                    <p id="dash-total-expense" class="text-2xl font-bold text-slate-800">$0</p>
                </div>
            </div>

            <!-- è¨ˆç•«é ç®—ç›£æ§ -->
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center">
                    <i data-lucide="pie-chart" class="w-5 h-5 mr-2 text-teal-600"></i>
                    è¨ˆç•«é ç®—ç›£æ§
                </h3>
                <div id="project-stats-container" class="space-y-4">
                    <!-- Javascript å°‡åœ¨æ­¤æ’å…¥å…§å®¹ -->
                </div>
            </div>
        </div>

        <!-- 2. è¨˜å¸³è¡¨å–® (Entry Form) -->
        <div id="view-entry" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100 max-w-2xl mx-auto">
                <h2 class="text-lg font-bold text-slate-700 mb-6 flex items-center">
                    <i data-lucide="file-plus" class="w-5 h-5 mr-2 text-teal-600"></i>
                    æ–°å¢å‚³ç¥¨
                </h2>
                
                <form id="entry-form" class="space-y-5">
                    <!-- é¡å‹åˆ‡æ› -->
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button type="button" onclick="setFormType('expense')" id="btn-type-expense" class="flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white text-rose-600 shadow-sm">æ”¯å‡º</button>
                        <button type="button" onclick="setFormType('income')" id="btn-type-income" class="flex-1 py-2 rounded-md text-sm font-bold transition-all text-slate-500">æ”¶å…¥</button>
                    </div>
                    <input type="hidden" id="input-type" value="expense">

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">æ—¥æœŸ</label>
                            <input type="date" id="input-date" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">é‡‘é¡</label>
                            <input type="number" id="input-amount" required placeholder="0" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none font-mono">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">æ­¸å±¬è¨ˆç•«</label>
                        <select id="input-project" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white">
                            <option value="" disabled selected>-- è«‹é¸æ“‡è¨ˆç•« --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">æœƒè¨ˆç§‘ç›®</label>
                        <select id="input-category" required class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none bg-white">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">æ‘˜è¦</label>
                        <input type="text" id="input-summary" required placeholder="èªªæ˜ç”¨é€”..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">å°è±¡ (Payee)</label>
                            <input type="text" id="input-payee" class="w-full p-2 border border-slate-300 rounded-lg outline-none">
                         </div>
                         <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">å‚™è¨»</label>
                            <input type="text" id="input-note" class="w-full p-2 border border-slate-300 rounded-lg outline-none">
                         </div>
                    </div>

                    <button type="submit" id="btn-submit" class="w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded-xl shadow-md transition-transform active:scale-95 flex items-center justify-center">
                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>
                        å„²å­˜æ”¯å‡º
                    </button>
                </form>
            </div>
        </div>

        <!-- 3. æ˜ç´°åˆ—è¡¨ (List) -->
        <div id="view-list" class="view-section hidden fade-in">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-slate-700">æ”¶æ”¯æ˜ç´°è¡¨</h3>
                <button onclick="exportCSV()" class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg flex items-center transition-colors">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    åŒ¯å‡º Excel
                </button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-semibold border-b border-slate-200">
                            <tr>
                                <th class="px-4 py-3 whitespace-nowrap">æ—¥æœŸ</th>
                                <th class="px-4 py-3 whitespace-nowrap">æ‘˜è¦/ç§‘ç›®</th>
                                <th class="px-4 py-3 text-right whitespace-nowrap">é‡‘é¡</th>
                                <th class="px-4 py-3 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body" class="divide-y divide-slate-100">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 4. è¨­å®šé é¢ (Settings) -->
        <div id="view-settings" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center">
                    <i data-lucide="link-2" class="w-6 h-6 mr-2 text-teal-600"></i>
                    é›²ç«¯é€£ç·šè¨­å®š
                </h2>
                
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6 text-sm text-blue-800">
                    <h4 class="font-bold mb-2">å¦‚ä½•é€£ç·šåˆ° Google Sheet?</h4>
                    <ol class="list-decimal ml-5 space-y-1">
                        <li>ç¢ºèªæ‚¨å·²éƒ¨ç½² Apps Script ç‚ºã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</li>
                        <li>æ¬Šé™è¨­ç‚ºã€Œæ‰€æœ‰äºº (Anyone)ã€ã€‚</li>
                        <li>å°‡ç”¢ç”Ÿçš„ç¶²å€è²¼åœ¨ä¸‹æ–¹ã€‚</li>
                    </ol>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-1">Google Apps Script ç¶²å€</label>
                        <input type="text" id="input-api-url" placeholder="https://script.google.com/macros/s/..../exec" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none text-sm font-mono text-slate-600">
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="saveSettings()" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg transition-colors flex justify-center items-center">
                            <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                            å„²å­˜ä¸¦é€£ç·š
                        </button>
                        <button onclick="clearSettings()" id="btn-disconnect" class="hidden px-4 border border-rose-200 text-rose-600 hover:bg-rose-50 font-bold py-2 rounded-lg transition-colors">
                            æ–·é–‹
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- æ‰‹æ©Ÿç‰ˆåº•éƒ¨å°èˆª -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 md:hidden flex justify-around items-center z-50 pb-safe">
        <button onclick="switchTab('dashboard')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-teal-600" id="nav-dashboard">
            <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1">ç¸½è¦½</span>
        </button>
        <button onclick="switchTab('entry')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-slate-400" id="nav-entry">
            <i data-lucide="plus-circle" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1">è¨˜å¸³</span>
        </button>
        <button onclick="switchTab('list')" class="nav-btn flex flex-col items-center p-2 rounded-lg text-slate-400" id="nav-list">
            <i data-lucide="table" class="w-6 h-6"></i>
            <span class="text-[10px] mt-1">æ˜ç´°</span>
        </button>
    </div>

    <!-- JAVASCRIPT é‚è¼¯æ ¸å¿ƒ -->
    <script>
        // --- 1. è³‡æ–™ç‹€æ…‹ (State) ---
        const MOCK_PROJECTS = [
            { id: 'PROJ_001', name: 'ç¯„ä¾‹-éƒ¨è½æ–‡åŒ–å‚³æ‰¿è¨ˆç•«', budget: 500000, funder: 'åŸæ°‘æœƒ' },
            { id: 'PROJ_002', name: 'ç¯„ä¾‹-ç’°å¢ƒæ•™è‚²æ¨å»£æ¡ˆ', budget: 120000, funder: 'ç’°ä¿å±€' }
        ];
        const MOCK_CATEGORIES = [
            { type: 'expense', name: 'æ¥­å‹™è²»-è¬›å¸«è²»' }, { type: 'expense', name: 'æ¥­å‹™è²»-ææ–™è²»' }, { type: 'expense', name: 'é›œæ”¯' },
            { type: 'income', name: 'æ”¿åºœè£œåŠ©æ¬¾' }, { type: 'income', name: 'ä¸€èˆ¬ææ¬¾' }
        ];

        let state = {
            transactions: [],
            projects: MOCK_PROJECTS,
            categories: MOCK_CATEGORIES,
            apiUrl: '',
            isConnected: false
        };

        // --- 2. åˆå§‹åŒ– (Init) ---
        window.onload = function() {
            lucide.createIcons();
            
            // è¨­å®šæ—¥æœŸé è¨­å€¼ç‚ºä»Šå¤©
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];

            // è®€å–è¨­å®š
            const savedUrl = localStorage.getItem('onanip_api_url');
            if (savedUrl) {
                state.apiUrl = savedUrl;
                document.getElementById('input-api-url').value = savedUrl;
                fetchDataFromGoogleSheet(savedUrl);
            } else {
                // è®€å–æœ¬åœ°æš«å­˜è³‡æ–™
                const localData = localStorage.getItem('onanip_local_data');
                if (localData) state.transactions = JSON.parse(localData);
                updateUI();
            }

            // åˆå§‹åŒ–è¡¨å–®é¸å–®
            updateFormOptions();
        };

        // --- 3. æ ¸å¿ƒåŠŸèƒ½ (Logic) ---

        // å¾ Google Sheet è®€å–è³‡æ–™
        async function fetchDataFromGoogleSheet(url) {
            showLoading(true);
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (data) {
                    state.projects = data.projects || MOCK_PROJECTS;
                    state.transactions = data.transactions || [];
                    if (data.categories && data.categories.length > 0) {
                        state.categories = data.categories;
                    }
                    setConnectionStatus(true);
                    showToast('âœ… å·²åŒæ­¥é›²ç«¯è³‡æ–™');
                    updateUI();
                }
            } catch (error) {
                console.error(error);
                showToast('âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€', 'error');
                setConnectionStatus(false);
            } finally {
                showLoading(false);
            }
        }

        // å„²å­˜è³‡æ–™
        async function saveData(e) {
            e.preventDefault();
            
            const formData = {
                id: Date.now().toString(),
                date: document.getElementById('input-date').value,
                type: document.getElementById('input-type').value,
                projectId: document.getElementById('input-project').value,
                category: document.getElementById('input-category').value,
                summary: document.getElementById('input-summary').value,
                amount: parseInt(document.getElementById('input-amount').value),
                payee: document.getElementById('input-payee').value,
                note: document.getElementById('input-note').value,
            };

            if(!formData.summary || !formData.amount || !formData.projectId) {
                showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š', 'error');
                return;
            }

            // æ¨‚è§€æ›´æ–° (å…ˆæ›´æ–°ç•«é¢)
            state.transactions.unshift(formData);
            updateUI();

            // å¯«å…¥å¾Œç«¯
            if (state.isConnected && state.apiUrl) {
                try {
                    await fetch(state.apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'add', ...formData })
                    });
                    showToast('âœ… è³‡æ–™å·²ä¸Šå‚³é›²ç«¯');
                } catch (err) {
                    showToast('âš ï¸ é›²ç«¯å¯«å…¥å¤±æ•—', 'error');
                }
            } else {
                localStorage.setItem('onanip_local_data', JSON.stringify(state.transactions));
                showToast('âœ… å·²å„²å­˜ (æœ¬æ©Ÿæ¨¡å¼)');
            }

            // é‡ç½®è¡¨å–® (ä¿ç•™éƒ¨åˆ†)
            document.getElementById('input-amount').value = '';
            document.getElementById('input-summary').value = '';
            document.getElementById('input-payee').value = '';
            document.getElementById('input-note').value = '';
        }
        document.getElementById('entry-form').addEventListener('submit', saveData);

        // åˆªé™¤è³‡æ–™
        async function deleteData(id) {
            if(!confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) return;

            state.transactions = state.transactions.filter(t => String(t.id) !== String(id));
            updateUI();

            if (state.isConnected && state.apiUrl) {
                try {
                    await fetch(state.apiUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'delete', id: id })
                    });
                    showToast('ğŸ—‘ï¸ é›²ç«¯è³‡æ–™å·²åˆªé™¤');
                } catch(e) { showToast('âš ï¸ åˆªé™¤å¤±æ•—'); }
            } else {
                localStorage.setItem('onanip_local_data', JSON.stringify(state.transactions));
                showToast('ğŸ—‘ï¸ å·²åˆªé™¤ (æœ¬æ©Ÿ)');
            }
        }

        // --- 4. ä»‹é¢æ›´æ–° (Render) ---

        function updateUI() {
            renderDashboard();
            renderTable();
            renderFormOptions();
            lucide.createIcons(); // é‡æ–°ç¹ªè£½åœ–ç¤º
        }

        function renderDashboard() {
            // è¨ˆç®—ç¸½å’Œ
            const totalIncome = state.transactions.filter(t => t.type === 'income').reduce((acc, c) => acc + (parseInt(c.amount)||0), 0);
            const totalExpense = state.transactions.filter(t => t.type === 'expense').reduce((acc, c) => acc + (parseInt(c.amount)||0), 0);
            
            document.getElementById('dash-total-income').textContent = `$${totalIncome.toLocaleString()}`;
            document.getElementById('dash-total-expense').textContent = `$${totalExpense.toLocaleString()}`;

            // è¨ˆç®—å°ˆæ¡ˆé€²åº¦
            const container = document.getElementById('project-stats-container');
            container.innerHTML = '';
            
            if (state.projects.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 text-sm">ç„¡è¨ˆç•«è³‡æ–™</p>';
                return;
            }

            state.projects.forEach(proj => {
                const used = state.transactions
                    .filter(t => String(t.projectId) === String(proj.id) && t.type === 'expense')
                    .reduce((acc, c) => acc + (parseInt(c.amount)||0), 0);
                
                const percent = Math.min(Math.round((used / proj.budget) * 100) || 0, 100);
                let colorClass = 'bg-teal-500';
                if (percent > 70) colorClass = 'bg-amber-400';
                if (percent > 90) colorClass = 'bg-rose-500';

                const html = `
                    <div class="pb-3 border-b border-slate-50 last:border-0 last:pb-0">
                        <div class="flex justify-between items-end mb-1">
                            <span class="font-medium text-slate-700 text-sm">${proj.name}</span>
                            <span class="text-xs text-slate-500">
                                å·²ç”¨ <span class="font-bold text-slate-700">$${used.toLocaleString()}</span> / ${proj.budget.toLocaleString()}
                            </span>
                        </div>
                        <div class="w-full bg-slate-100 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-500 ${colorClass}" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('transaction-table-body');
            tbody.innerHTML = '';
            
            const sorted = [...state.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(t => {
                const isIncome = String(t.type) === 'income';
                const projName = state.projects.find(p => String(p.id) === String(t.projectId))?.name || 'æœªçŸ¥è¨ˆç•«';
                
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50';
                tr.innerHTML = `
                    <td class="px-4 py-3 align-top whitespace-nowrap">
                        <div class="font-mono text-slate-600">${t.date}</div>
                        <div class="text-xs text-slate-400 truncate max-w-[100px]">${projName}</div>
                    </td>
                    <td class="px-4 py-3 align-top">
                        <div class="font-medium text-slate-800">${t.summary}</div>
                        <div class="text-xs text-slate-500">${t.category}</div>
                    </td>
                    <td class="px-4 py-3 text-right font-mono font-bold align-top ${isIncome ? 'text-emerald-600' : 'text-rose-600'}">
                        ${isIncome ? '+' : '-'}${parseInt(t.amount).toLocaleString()}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="deleteData('${t.id}')" class="text-slate-300 hover:text-rose-500 p-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ›´æ–°è¡¨å–®é¸é … (è¨ˆç•« & ç§‘ç›®)
        function updateFormOptions() {
            // è¨ˆç•«
            const projSelect = document.getElementById('input-project');
            const currentProj = projSelect.value; // ä¿æŒç•¶å‰é¸æ“‡
            projSelect.innerHTML = '<option value="" disabled selected>-- è«‹é¸æ“‡è¨ˆç•« --</option>';
            state.projects.forEach(p => {
                projSelect.insertAdjacentHTML('beforeend', `<option value="${p.id}">${p.name}</option>`);
            });
            if(currentProj) projSelect.value = currentProj;

            // ç§‘ç›® (æ ¹æ“šç•¶å‰é¡å‹ Expense/Income)
            const type = document.getElementById('input-type').value;
            const catSelect = document.getElementById('input-category');
            catSelect.innerHTML = '';
            
            const filteredCats = state.categories.filter(c => c.type === type);
            if(filteredCats.length === 0) {
                catSelect.innerHTML = '<option>ç„¡å¯ç”¨ç§‘ç›®</option>';
            } else {
                filteredCats.forEach(c => {
                    catSelect.insertAdjacentHTML('beforeend', `<option value="${c.name}">${c.name}</option>`);
                });
            }
        }

        // --- 5. è¼”åŠ©åŠŸèƒ½ (Helpers) ---

        function switchTab(tabId) {
            // éš±è—æ‰€æœ‰é é¢
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // é¡¯ç¤ºé¸ä¸­é é¢
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            // æ›´æ–°æ‰‹æ©Ÿåº•éƒ¨å°èˆªæ¨£å¼
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-teal-600');
                el.classList.add('text-slate-400');
            });
            const navBtn = document.getElementById(`nav-${tabId}`);
            if(navBtn) {
                navBtn.classList.remove('text-slate-400');
                navBtn.classList.add('text-teal-600');
            }
        }

        function setFormType(type) {
            document.getElementById('input-type').value = type;
            const btnExp = document.getElementById('btn-type-expense');
            const btnInc = document.getElementById('btn-type-income');
            const submitBtn = document.getElementById('btn-submit');
            
            if (type === 'expense') {
                btnExp.className = 'flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white text-rose-600 shadow-sm';
                btnInc.className = 'flex-1 py-2 rounded-md text-sm font-bold transition-all text-slate-500';
                submitBtn.className = 'w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-3 rounded-xl shadow-md transition-transform active:scale-95 flex items-center justify-center';
                submitBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜æ”¯å‡º';
            } else {
                btnInc.className = 'flex-1 py-2 rounded-md text-sm font-bold transition-all bg-white text-emerald-600 shadow-sm';
                btnExp.className = 'flex-1 py-2 rounded-md text-sm font-bold transition-all text-slate-500';
                submitBtn.className = 'w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-md transition-transform active:scale-95 flex items-center justify-center';
                submitBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜æ”¶å…¥';
            }
            updateFormOptions(); // æ›´æ–°ç§‘ç›®
            lucide.createIcons();
        }

        function saveSettings() {
            const url = document.getElementById('input-api-url').value.trim();
            if (url) {
                localStorage.setItem('onanip_api_url', url);
                state.apiUrl = url;
                fetchDataFromGoogleSheet(url);
            }
        }

        function clearSettings() {
            localStorage.removeItem('onanip_api_url');
            state.apiUrl = '';
            state.isConnected = false;
            document.getElementById('input-api-url').value = '';
            setConnectionStatus(false);
            // å›å¾©æ¨¡æ“¬è³‡æ–™
            state.categories = MOCK_CATEGORIES;
            state.projects = MOCK_PROJECTS;
            showToast('å·²åˆ‡æ›å›æ¨¡æ“¬æ¨¡å¼');
            updateUI();
        }

        function setConnectionStatus(connected) {
            state.isConnected = connected;
            const statusEl = document.getElementById('connection-status');
            const navbar = document.getElementById('navbar');
            const btnDisconnect = document.getElementById('btn-disconnect');

            if (connected) {
                navbar.classList.remove('bg-slate-700');
                navbar.classList.add('bg-teal-700');
                statusEl.innerHTML = '<i data-lucide="check-circle" class="w-3 h-3"></i><span>é›²ç«¯å·²é€£ç·š</span>';
                statusEl.className = 'flex items-center space-x-2 text-xs opacity-90 text-emerald-300';
                btnDisconnect.classList.remove('hidden');
            } else {
                navbar.classList.remove('bg-teal-700');
                navbar.classList.add('bg-slate-700');
                statusEl.innerHTML = '<i data-lucide="alert-circle" class="w-3 h-3"></i><span>æ¨¡æ“¬æ¨¡å¼</span>';
                statusEl.className = 'flex items-center space-x-2 text-xs opacity-90 text-orange-300';
                btnDisconnect.classList.add('hidden');
            }
            lucide.createIcons();
        }

        function showLoading(show) {
            const el = document.getElementById('loading-overlay');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }

        function showToast(msg, type='success') {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toast-msg');
            
            toastMsg.innerText = msg;
            toast.className = `fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl z-50 text-white transition-all duration-300 transform translate-y-0 opacity-100 ${type === 'error' ? 'bg-rose-600' : 'bg-emerald-600'}`;
            
            setTimeout(() => {
                toast.classList.add('translate-y-[-20px]', 'opacity-0');
            }, 3000);
        }

        function exportCSV() {
            const headers = ['æ—¥æœŸ', 'é¡å‹', 'è¨ˆç•«ä»£ç¢¼', 'è¨ˆç•«åç¨±', 'ç§‘ç›®', 'æ‘˜è¦', 'å°è±¡', 'é‡‘é¡', 'å‚™è¨»'];
            const csvContent = [
                headers.join(','),
                ...state.transactions.map(t => {
                    const projName = state.projects.find(p => String(p.id) === String(t.projectId))?.name || 'æœªçŸ¥è¨ˆç•«';
                    return [
                        t.date,
                        t.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                        t.projectId,
                        `"${projName}"`,
                        t.category,
                        `"${t.summary}"`,
                        t.payee || '',
                        t.amount,
                        t.note || ''
                    ].join(',');
                })
            ].join('\n');

            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `onanip_accounting_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>

