<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ - æœƒè¨ˆç³»çµ± (V20 Bank Account)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- å¼•å…¥ html2pdf ç”¨æ–¼ç”¢ç”Ÿ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* è¢å¹•é è¦½æ¨£å¼ */
        .preview-table { width: 100%; border-collapse: collapse; border: 1px solid #333; margin-bottom: 20px; }
        .preview-table th, .preview-table td { border: 1px solid #333; padding: 6px 8px; font-size: 14px; }
        .preview-table th { background-color: #f3f4f6; text-align: center; font-weight: bold; }
        .amount-col { text-align: right; font-family: monospace; }
        .sign-box { height: 80px; vertical-align: bottom; text-align: center; }
        /* èª¿æ•´æ†‘è­‰é»è²¼è™•é«˜åº¦è‡³ 400px (åŠ å¤§) */
        .attachment-area { border: 2px dashed #94a3b8; height: 400px; display: flex; align-items: center; justify-content: center; background-color: #f8fafc; color: #64748b; font-weight: bold; margin: 15px 0; }

        /* PDF è¼¸å‡ºå°ˆç”¨èª¿æ•´ */
        .pdf-content {
            font-size: 12pt;
            line-height: 1.5;
        }
        
        /* é ç®—çµ±è¨ˆè³‡è¨Šå€å¡Š */
        .budget-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            font-size: 0.9em;
        }
        .budget-item {
            text-align: center;
        }
        .budget-label {
            font-size: 0.8em;
            color: #64748b;
        }
        .budget-value {
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1em;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-24 md:pb-10">

    <!-- Login -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-800 z-[150] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 fade-in relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-teal-500 to-emerald-500"></div>
            <div class="text-center mb-8">
                <div class="bg-teal-50 p-4 rounded-full inline-block mb-4 ring-4 ring-teal-100"><i data-lucide="shield-check" class="w-10 h-10 text-teal-600"></i></div>
                <h1 class="text-2xl font-bold text-slate-800">'onanip æœƒè¨ˆç³»çµ± V20</h1>
            </div>
            <form id="login-form" class="space-y-5">
                <div><label class="text-xs font-bold text-slate-500 uppercase ml-1">å¸³è™Ÿ</label><input type="text" id="login-id" class="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="user"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase ml-1">å¯†ç¢¼</label><input type="password" id="login-pwd" class="w-full p-3 border border-slate-300 rounded-lg outline-none" placeholder="â€¢â€¢â€¢â€¢"></div>
                <button type="submit" id="btn-login" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-700 transition-all flex justify-center items-center shadow-lg">ç™»å…¥ç³»çµ±</button>
            </form>
            <div id="login-msg" class="mt-4 text-center text-rose-500 text-sm font-bold hidden bg-rose-50 p-2 rounded"></div>
            <div class="mt-6 pt-6 border-t text-center"><button onclick="showSettingsOnly()" class="text-slate-400 text-xs hover:text-teal-600">è¨­å®šé€£ç·š</button></div>
        </div>
    </div>

    <!-- Nav -->
    <nav id="navbar" class="bg-slate-700 text-white shadow-lg sticky top-0 z-50 transition-colors duration-300 no-print">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-white p-1.5 rounded-full text-slate-700"><i data-lucide="wallet" class="w-6 h-6"></i></div>
                <div>
                    <h1 class="text-lg font-bold tracking-wide hidden md:block">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1>
                    <h1 class="text-lg font-bold tracking-wide md:hidden">'onanip æœƒè¨ˆ</h1>
                    <div id="user-badge" class="flex items-center space-x-2 text-xs opacity-90 text-slate-300"><i data-lucide="user" class="w-3 h-3"></i><span id="user-display">æœªç™»å…¥</span></div>
                </div>
            </div>
            <div class="hidden md:flex space-x-2 bg-slate-800/50 p-1 rounded-lg">
                <button onclick="switchTab('dashboard')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-teal-300 bg-white/10">ç¸½è¦½</button>
                <button onclick="switchTab('entry')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:bg-white/10">è¨˜å¸³</button>
                <button onclick="switchTab('list')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:bg-white/10">æ˜ç´°</button>
                <button onclick="switchTab('projects')" class="desktop-nav-btn px-4 py-2 rounded-md text-sm font-bold text-slate-300 hover:bg-white/10">è¨ˆç•«</button>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="switchTab('settings')" class="p-2 hover:bg-white/10 rounded-full border border-white/20"><i data-lucide="settings" class="w-5 h-5"></i></button>
                <button onclick="logout()" class="p-2 hover:bg-rose-600 rounded-full border border-white/20"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 py-6 no-print">
        <!-- Settings -->
        <div id="view-settings" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100 max-w-xl mx-auto mt-6">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center"><i data-lucide="link" class="w-6 h-6 mr-2 text-teal-600"></i> é€£ç·šè¨­å®š</h2>
                <input type="text" id="api-url-input" placeholder="GAS URL" class="w-full p-3 border border-slate-300 rounded-lg mb-4">
                <button onclick="saveAndConnect()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-lg">å„²å­˜ä¸¦é€£ç·š</button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="view-dashboard" class="view-section hidden fade-in">
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500"><p class="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¶å…¥</p><p id="total-income" class="text-2xl font-bold text-slate-800">$0</p></div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-rose-500"><p class="text-xs text-slate-500 mb-1">æœ¬æœŸç¸½æ”¯å‡º</p><p id="total-expense" class="text-2xl font-bold text-slate-800">$0</p></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-5 border border-slate-100"><div id="project-stats" class="space-y-4"></div></div>
        </div>

        <!-- Entry Form -->
        <div id="view-entry" class="view-section hidden fade-in">
            <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100 max-w-2xl mx-auto relative">
                <div id="edit-mode-indicator" class="hidden absolute top-0 right-0 bg-amber-100 text-amber-700 text-xs font-bold px-3 py-1 rounded-bl-lg rounded-tr-lg border-b border-l border-amber-200">ä¿®æ”¹æ¨¡å¼</div>
                <h2 class="text-lg font-bold text-slate-700 mb-6 flex items-center"><i data-lucide="file-plus" class="w-6 h-6 mr-2 text-teal-600"></i> <span id="form-title">æ–°å¢ç´€éŒ„</span></h2>
                <form id="entry-form" class="space-y-5">
                    <div class="flex bg-slate-100 p-1 rounded-lg">
                        <button type="button" onclick="setType('expense')" id="btn-expense" class="flex-1 py-3 rounded-md text-sm font-bold bg-white text-rose-600 shadow-sm transition-all">æ”¯å‡º</button>
                        <button type="button" onclick="setType('income')" id="btn-income" class="flex-1 py-3 rounded-md text-sm font-bold text-slate-500 transition-all">æ”¶å…¥</button>
                    </div>
                    <input type="hidden" id="inp-type" value="expense"><input type="hidden" id="inp-id" value="">
                    <div class="grid grid-cols-2 gap-4"><input type="date" id="inp-date" required class="w-full p-3 border rounded-lg"><input type="number" id="inp-amount" required placeholder="é‡‘é¡" class="w-full p-3 border rounded-lg font-mono"></div>
                    <select id="inp-project" required class="w-full p-3 border rounded-lg bg-white"></select><select id="inp-category" required class="w-full p-3 border rounded-lg bg-white"></select>
                    <input type="text" id="inp-summary" required placeholder="æ‘˜è¦" class="w-full p-3 border rounded-lg">
                    <!-- ä¿®æ”¹å€åŸŸï¼šå°è±¡èˆ‡åŒ¯æ¬¾å¸³è™Ÿä¸¦æ’ -->
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="inp-payee" placeholder="å°è±¡ (å—æ¬¾äºº)" class="w-full p-3 border rounded-lg">
                        <input type="text" id="inp-bank-account" placeholder="åŒ¯æ¬¾å¸³è™Ÿ" class="w-full p-3 border rounded-lg">
                    </div>
                    <!-- å‚™è¨»ç¨ç«‹ä¸€è¡Œ -->
                    <input type="text" id="inp-note" placeholder="å‚™è¨»" class="w-full p-3 border rounded-lg">
                    
                    <div class="flex space-x-3">
                        <button type="button" id="btn-cancel-edit" onclick="cancelEdit()" class="hidden w-1/3 bg-slate-200 text-slate-600 font-bold py-4 rounded-xl">å–æ¶ˆ</button>
                        <button type="submit" id="btn-submit" class="w-full bg-rose-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center"><i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜ä¸¦åˆ—å°</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- List -->
        <div id="view-list" class="view-section hidden fade-in">
            <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-slate-700">æ”¶æ”¯æ˜ç´°</h3>
                <button onclick="openReportModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center font-bold text-sm hover:bg-indigo-700 shadow-md">
                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i> ä¸‹è¼‰å ±è¡¨ (PDF)
                </button>
            </div>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden min-h-[300px]">
                <table class="w-full text-sm text-left">
                    <thead class="bg-slate-50 text-slate-500 font-semibold border-b"><tr><th class="px-4 py-3">å…§å®¹</th><th class="px-4 py-3 text-right">é‡‘é¡</th><th class="px-4 py-3 text-center w-[120px]">æ“ä½œ</th></tr></thead>
                    <tbody id="list-body" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <!-- Projects -->
        <div id="view-projects" class="view-section hidden fade-in">
             <div class="bg-white rounded-2xl shadow-md p-6 border border-slate-100">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center"><i data-lucide="list" class="w-6 h-6 mr-2 text-teal-600"></i> è¨ˆç•«åˆ—è¡¨</h2>
                <div id="projects-list-content" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <!-- Report Modal -->
    <div id="report-modal" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 fade-in">
            <h3 class="text-xl font-bold text-slate-800 mb-4 border-b pb-2">ğŸ–¨ï¸ ç”¢å‡ºè²¡å‹™å ±è¡¨</h3>
            <div class="space-y-4">
                <div><label class="block text-sm font-bold text-slate-600 mb-1">ç¯©é¸è¨ˆç•«</label><select id="rpt-project" class="w-full p-2 border rounded bg-white"><option value="ALL">å…¨éƒ¨è¨ˆç•«</option></select></div>
                <!-- å…¨å¹´åº¦å‹¾é¸ -->
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">æœˆä»½ / æœŸé–“</label>
                    <div class="flex items-center space-x-2">
                        <input type="month" id="rpt-month" class="flex-1 p-2 border rounded bg-white">
                        <label class="flex items-center space-x-1 text-sm text-slate-600 bg-slate-50 px-2 py-2 rounded border cursor-pointer hover:bg-slate-100">
                            <input type="checkbox" id="rpt-full-year" onchange="toggleReportDate()" class="rounded text-indigo-600">
                            <span>åˆ—å°å…¨å¹´åº¦</span>
                        </label>
                    </div>
                </div>
                <div><label class="block text-sm font-bold text-slate-600 mb-2">å ±è¡¨é¡å‹</label>
                    <div class="space-y-2">
                        <label class="flex items-center p-2 border rounded hover:bg-slate-50"><input type="radio" name="rpt-type" value="journal" checked class="mr-2">æ—¥è¨˜å¸³ (ç›´å¼)</label>
                        <label class="flex items-center p-2 border rounded hover:bg-slate-50"><input type="radio" name="rpt-type" value="ledger" class="mr-2">åˆ†é¡å¸³ (æ©«å¼)</label>
                        <label class="flex items-center p-2 border rounded hover:bg-slate-50"><input type="radio" name="rpt-type" value="monthly" class="mr-2">æ”¶æ”¯æœˆå ±è¡¨ (ç›´å¼)</label>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex space-x-3">
                <button onclick="document.getElementById('report-modal').classList.add('hidden')" class="w-1/2 bg-slate-200 text-slate-600 font-bold py-3 rounded-xl">å–æ¶ˆ</button>
                <button onclick="generateReport()" class="w-1/2 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg">ä¸‹è¼‰ PDF</button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="print-modal" class="fixed inset-0 bg-black/50 z-[250] hidden flex items-center justify-center p-4">
        <!-- å¢åŠ  max-w-none èˆ‡ overflow-x-auto è®“æ‰‹æ©Ÿä¹Ÿèƒ½å®Œæ•´æª¢è¦– -->
        <div class="bg-white w-full max-w-3xl p-4 rounded-lg shadow-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-lg text-slate-700">é è¦½èˆ‡ä¸‹è¼‰</h3>
                <button onclick="document.getElementById('print-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <!-- é è¦½å€åŸŸ -->
            <div id="printable-area" class="flex-1 overflow-y-auto overflow-x-auto bg-slate-50 p-4 border rounded">
                <div id="print-content" class="bg-white p-4 shadow-sm mx-auto"></div>
            </div>

            <div class="mt-4 flex justify-end space-x-4">
                <button onclick="document.getElementById('print-modal').classList.add('hidden')" class="px-6 py-2 border rounded-lg font-bold">é—œé–‰</button>
                <button onclick="downloadCurrentPDF()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-bold flex items-center shadow-lg active:scale-95 transition-transform"><i data-lucide="download" class="w-5 h-5 mr-2"></i> å„²å­˜ PDF</button>
            </div>
        </div>
    </div>

    <!-- Toast & Loading & Mobile Nav -->
    <div id="toast" class="hidden fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl z-[300] text-white transition-all duration-300 transform"><span id="toast-msg"></span></div>
    <div id="loading" class="fixed inset-0 bg-white/90 z-[300] hidden flex flex-col items-center justify-center backdrop-blur-sm"><i data-lucide="loader-2" class="w-12 h-12 animate-spin text-teal-600 mb-4"></i><p class="text-slate-600 font-bold text-lg">è™•ç†ä¸­...</p></div>
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 flex justify-around z-50 pb-safe no-print">
        <button onclick="switchTab('dashboard')" class="nav-btn text-teal-600 flex flex-col items-center p-2 w-full"><i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="text-[10px]">ç¸½è¦½</span></button>
        <button onclick="switchTab('entry')" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-full"><i data-lucide="plus-circle" class="w-6 h-6"></i><span class="text-[10px]">è¨˜å¸³</span></button>
        <button onclick="switchTab('list')" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-full"><i data-lucide="table" class="w-6 h-6"></i><span class="text-[10px]">æ˜ç´°</span></button>
        <button onclick="switchTab('projects')" class="nav-btn text-slate-400 flex flex-col items-center p-2 w-full"><i data-lucide="list" class="w-6 h-6"></i><span class="text-[10px]">è¨ˆç•«</span></button>
    </div>

    <script>
        let state = { apiUrl: '', transactions: [], projects: [], categories: [], users: [], currentUser: null };
        let toastTimeout;

        window.onload = () => {
            lucide.createIcons();
            document.getElementById('inp-date').value = new Date().toISOString().split('T')[0];
            const savedUrl = localStorage.getItem('onanip_url');
            if (savedUrl) { state.apiUrl = savedUrl; document.getElementById('api-url-input').value = savedUrl; fetchData(false); }
            else { document.getElementById('login-overlay').classList.add('hidden'); switchTab('settings'); }
        };

        async function apiCall(payload) {
            if (!state.apiUrl) throw new Error("æœªè¨­å®šé€£ç·šç¶²å€");
            
            // å®‰å…¨æ€§ä¿®æ­£ï¼šå¦‚æœå¾Œç«¯ä¸æ”¯æ´ payee æ¬„ä½ï¼Œé€™æœƒç¢ºä¿ payee ä¸æœƒæ¶ˆå¤±
            const res = await fetch(state.apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) throw new Error(`Server Error: ${res.status}`);
            const data = await res.json();
            if (data.status === 'error') throw new Error(data.message || 'æ“ä½œå¤±æ•—');
            return data;
        }

        async function fetchData() {
            showLoading(true);
            try {
                const res = await fetch(state.apiUrl); 
                const data = await res.json();
                if (data.status === 'error') throw new Error(data.message);
                
                state.projects = data.projects || []; 
                state.transactions = data.transactions || [];
                state.categories = data.categories || []; 
                state.users = data.users || [];
                
                document.getElementById('login-overlay').classList.remove('hidden'); 
                showToast('å·²é€£ç·š');
            } catch (e) { 
                console.error(e);
                showToast('é€£ç·šå¤±æ•—: ' + e.message, 'error'); 
                document.getElementById('login-overlay').classList.add('hidden'); 
                switchTab('settings'); 
            } finally { 
                showLoading(false); 
            }
        }

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('login-id').value.trim(); 
            const pwd = document.getElementById('login-pwd').value.trim();
            const user = state.users.find(u => String(u.id) === id && String(u.password) === pwd);
            if (user) {
                state.currentUser = user; 
                document.getElementById('login-overlay').classList.add('hidden');
                updateUI(); switchTab('dashboard'); showToast(`æ­¡è¿ ${user.name}`);
                document.getElementById('user-display').innerText = `${user.name} (${user.role})`;
                document.getElementById('navbar').classList.replace('bg-slate-700', 'bg-teal-700');
            } else { 
                document.getElementById('login-msg').innerText = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤"; 
                document.getElementById('login-msg').classList.remove('hidden'); 
            }
        };

        // --- PDF Generation Logic (Fixed for A4 Margins) ---
        function downloadCurrentPDF() {
            const element = document.getElementById('print-content');
            // ç¸®å°å¯¬åº¦ä¸¦è¨­ç½® margin ä»¥é©æ‡‰ A4
            const isLandscape = document.getElementById('print-content').classList.contains('landscape-content');
            
            const opt = {
                margin:       [5, 5, 5, 5], // 0.5cm = 5mm
                filename:     `onanip_report_${new Date().toISOString().slice(0,10)}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: isLandscape ? 'landscape' : 'portrait' }
            };

            showLoading(true);
            html2pdf().set(opt).from(element).save().then(() => {
                showLoading(false);
                showToast('ä¸‹è¼‰æˆåŠŸ');
            }).catch(err => {
                showLoading(false);
                showToast('PDF ç”¢ç”Ÿå¤±æ•—', 'error');
                console.error(err);
            });
        }

        // Toggle Full Year
        function toggleReportDate() {
            const isFull = document.getElementById('rpt-full-year').checked;
            const mInput = document.getElementById('rpt-month');
            mInput.disabled = isFull;
            if (isFull) {
                mInput.classList.add('bg-slate-100', 'text-slate-400');
            } else {
                mInput.classList.remove('bg-slate-100', 'text-slate-400');
            }
        }

        function openReportModal() {
            const sel = document.getElementById('rpt-project');
            sel.innerHTML = '<option value="ALL">å…¨éƒ¨è¨ˆç•« (All Projects)</option>' + state.projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
            document.getElementById('rpt-month').value = new Date().toISOString().slice(0, 7);
            
            document.getElementById('rpt-full-year').checked = false;
            toggleReportDate();
            
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function generateReport() {
            const projId = document.getElementById('rpt-project').value;
            const isFullYear = document.getElementById('rpt-full-year').checked;
            const monthStr = isFullYear ? '' : document.getElementById('rpt-month').value;
            const type = document.querySelector('input[name="rpt-type"]:checked').value;
            
            let filtered = state.transactions.filter(t => {
                const safeDate = (t.date || '').split('T')[0];
                return ((projId==='ALL') || (String(t.projectId)===String(projId))) && (!monthStr || safeDate.startsWith(monthStr));
            });
            filtered.sort((a,b) => new Date(a.date) - new Date(b.date));

            const projName = projId === 'ALL' ? 'å…¨éƒ¨è¨ˆç•«' : (state.projects.find(p=>String(p.id)===String(projId))?.name || projId);
            const rptName = type==='journal'?'æ—¥è¨˜å¸³':type==='ledger'?'åˆ†é¡å¸³':'æ”¶æ”¯æœˆå ±è¡¨';
            
            // è¨ˆç®—é ç®—è³‡è¨Š
            let totalBudget = 0;
            let totalUsedAllTime = 0;

            if (projId === 'ALL') {
                totalBudget = state.projects.reduce((sum, p) => sum + (Number(p.budget) || 0), 0);
                totalUsedAllTime = state.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            } else {
                const p = state.projects.find(x => String(x.id) === String(projId));
                totalBudget = Number(p ? p.budget : 0);
                totalUsedAllTime = state.transactions
                    .filter(t => String(t.projectId) === String(projId) && t.type === 'expense')
                    .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);
            }
            const remainingBudget = totalBudget - totalUsedAllTime;
            
            const contentDiv = document.getElementById('print-content');
            const isLandscape = type === 'ledger';
            contentDiv.className = isLandscape ? 'landscape-content bg-white p-4 pdf-content mx-auto' : 'bg-white p-4 pdf-content mx-auto';
            contentDiv.style.width = isLandscape ? '287mm' : '200mm'; 

            let html = `<div class="text-center mb-4"><h1 class="text-2xl font-bold border-b-2 border-black inline-block pb-1">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1><h2 class="text-xl font-bold mt-2">${rptName}</h2><p class="text-sm mt-1">ç¯„åœï¼š${projName} | æœŸé–“ï¼š${isFullYear ? 'å…¨å¹´åº¦' : monthStr}</p></div>`;

            // åœ¨æ—¥è¨˜å¸³å’Œåˆ†é¡å¸³é¡¯ç¤ºé ç®—çµ±è¨ˆ
            if (type === 'journal' || type === 'ledger') {
                html += `
                <div class="budget-info">
                    <div class="budget-item"><div class="budget-label">ç¸½é ç®—</div><div class="budget-value text-slate-700">$${totalBudget.toLocaleString()}</div></div>
                    <div class="budget-item"><div class="budget-label">ç´¯è¨ˆæ”¯å‡º (è‡³ä»Šæ—¥)</div><div class="budget-value text-rose-600">$${totalUsedAllTime.toLocaleString()}</div></div>
                    <div class="budget-item"><div class="budget-label">é ç®—é¤˜é¡</div><div class="budget-value ${remainingBudget >= 0 ? 'text-emerald-600' : 'text-red-600'}">$${remainingBudget.toLocaleString()}</div></div>
                </div>`;
            }

            if (filtered.length === 0) html += '<p class="text-center py-10 text-slate-400">æŸ¥ç„¡è³‡æ–™</p>';
            else if (type === 'journal') {
                html += `<table class="preview-table"><thead><tr><th>æ—¥æœŸ</th><th>è¨ˆç•«</th><th>ç§‘ç›®</th><th>æ‘˜è¦</th><th class="text-right">æ”¶å…¥</th><th class="text-right">æ”¯å‡º</th></tr></thead><tbody>`;
                let sIn=0, sOut=0;
                filtered.forEach(t => {
                    const isInc = t.type === 'income'; const amt = Number(t.amount); if(isInc)sIn+=amt; else sOut+=amt;
                    const pName = state.projects.find(p=>String(p.id)===String(t.projectId))?.name || '';
                    const safeDate = (t.date || '').split('T')[0];
                    html += `<tr><td>${safeDate}</td><td>${pName}</td><td>${t.category}</td><td>${t.summary}</td><td class="amount-col">${isInc?amt.toLocaleString():''}</td><td class="amount-col">${!isInc?amt.toLocaleString():''}</td></tr>`;
                });
                html += `<tr style="font-weight:bold;background:#f8fafc"><td colspan="4" class="text-right">åˆè¨ˆï¼š</td><td class="amount-col">${sIn.toLocaleString()}</td><td class="amount-col">${sOut.toLocaleString()}</td></tr></tbody></table><div class="text-right font-bold mt-2">æœŸé–“çµé¤˜ï¼š$${(sIn-sOut).toLocaleString()}</div>`;
            } else if (type === 'ledger') {
                const groups = {}; filtered.forEach(t => { if(!groups[t.category]) groups[t.category]=[]; groups[t.category].push(t); });
                for(const cat in groups) {
                    const txs = groups[cat]; const total = txs.reduce((a,c)=>a+Number(c.amount),0);
                    html += `<h3 class="font-bold mt-6 mb-2 border-l-4 border-slate-500 pl-2 bg-slate-100 p-1">${cat}</h3><table class="preview-table"><thead><tr><th>æ—¥æœŸ</th><th>æ‘˜è¦</th><th>è¨ˆç•«</th><th class="text-right">é‡‘é¡</th></tr></thead><tbody>`;
                    txs.forEach(t => { const safeDate = (t.date || '').split('T')[0]; html += `<tr><td>${safeDate}</td><td>${t.summary}</td><td>${state.projects.find(p=>String(p.id)===String(t.projectId))?.name||''}</td><td class="amount-col">${Number(t.amount).toLocaleString()}</td></tr>`; });
                    html += `<tr style="font-weight:bold"><td colspan="3" class="text-right">å°è¨ˆï¼š</td><td class="amount-col">$${total.toLocaleString()}</td></tr></tbody></table>`;
                }
            } else {
                const iMap={}, eMap={}; filtered.forEach(t=>{ const a=Number(t.amount); if(t.type==='income') iMap[t.category]=(iMap[t.category]||0)+a; else eMap[t.category]=(eMap[t.category]||0)+a; });
                const tI = Object.values(iMap).reduce((a,b)=>a+b,0); const tE = Object.values(eMap).reduce((a,b)=>a+b,0);
                html += `<div style="display:flex;gap:20px;"><div style="flex:1"><table class="preview-table"><thead><tr><th colspan="2" style="text-align:center;background:#dcfce7">æ”¶å…¥</th></tr></thead><tbody>${Object.entries(iMap).map(([k,v])=>`<tr><td>${k}</td><td class="amount-col">${v.toLocaleString()}</td></tr>`).join('')}<tr style="font-weight:bold"><td>åˆè¨ˆ</td><td class="amount-col">${tI.toLocaleString()}</td></tr></tbody></table></div><div style="flex:1"><table class="preview-table"><thead><tr><th colspan="2" style="text-align:center;background:#fee2e2">æ”¯å‡º</th></tr></thead><tbody>${Object.entries(eMap).map(([k,v])=>`<tr><td>${k}</td><td class="amount-col">${v.toLocaleString()}</td></tr>`).join('')}<tr style="font-weight:bold"><td>åˆè¨ˆ</td><td class="amount-col">${tE.toLocaleString()}</td></tr></tbody></table></div></div><div class="text-center font-bold text-xl mt-4 border p-4 bg-slate-50">æœ¬æœŸçµé¤˜ï¼š$${(tI-tE).toLocaleString()}</div>`;
            }

            html += `<table class="sign-table" style="width:100%; border-collapse:collapse; margin-top:30px;">
                <tr>
                    <th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">ç†äº‹é•·</th>
                    <th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">ç¸½å¹¹äº‹</th>
                    <th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">æœƒè¨ˆ</th>
                    <th style="width:25%; border:1px solid #000; padding:5px; text-align:center;">å‡ºç´</th>
                </tr>
                <tr>
                    <td style="height:80px; border:1px solid #000;"></td>
                    <td style="height:80px; border:1px solid #000;"></td>
                    <td style="height:80px; border:1px solid #000;"></td>
                    <td style="height:80px; border:1px solid #000;"></td>
                </tr>
            </table>`;
            
            contentDiv.innerHTML = html;
            document.getElementById('report-modal').classList.add('hidden');
            document.getElementById('print-modal').classList.remove('hidden');
        }

        function openVoucher(transaction) {
            const proj = state.projects.find(p => String(p.id) === String(transaction.projectId)) || {name: 'æœªçŸ¥è¨ˆç•«', id: 'N/A'};
            const safeDate = (transaction.date || '').split('T')[0];
            const contentDiv = document.getElementById('print-content');
            contentDiv.className = 'bg-white p-4 pdf-content mx-auto'; 
            contentDiv.style.width = '200mm'; 

            // ä¿®æ­£ï¼šå¢åŠ å—æ¬¾äººæ¬„ä½ï¼Œä¸¦åŠ ä¸Šé˜²å‘† || '' é¿å… undefined
            const content = `
                <div class="text-center mb-6"><h1 class="text-2xl font-bold tracking-widest mb-2 border-b-2 border-black inline-block pb-1">èŠ±è“®ç¸£ 'onanip æ–‡æ•™å”æœƒ</h1><h2 class="text-xl font-bold mt-2">æ”¯ç”¨å–®æ“šé»è²¼æ†‘è­‰ç”¨ç´™</h2></div>
                <div class="flex justify-between mb-2 font-mono text-sm"><div><span class="font-bold">è¨ˆç•«ï¼š</span>${proj.id}</div><div><span class="font-bold">ç·¨è™Ÿï¼š</span>${String(transaction.id).slice(-6)}</div></div>
                <table class="preview-table mb-4 text-sm">
                    <tr><th>è¨ˆç•«åç¨±</th><td colspan="3">${proj.name}</td><th>ç”³è«‹æ—¥æœŸ</th><td>${safeDate}</td></tr>
                    
                    <!-- ä¿®æ­£å€åŸŸï¼šå°‡å—æ¬¾äººç¨ç«‹ä¸€æ¬„ï¼Œé¿å…è·Ÿå‚™è¨»æ··æ·† -->
                    <tr>
                        <th width="15%">ç§‘ç›®</th><td width="25%">${transaction.category}</td>
                        <th width="15%">å—æ¬¾äºº</th><td width="25%">${transaction.payee || ''}</td>
                        <th width="10%">é‡‘é¡</th><td class="font-bold font-mono text-lg">$${Number(transaction.amount).toLocaleString()}</td>
                    </tr>
                    
                    <!-- æ–°å¢åŒ¯æ¬¾å¸³è™Ÿæ¬„ä½ -->
                    <tr>
                        <th>åŒ¯æ¬¾å¸³è™Ÿ</th><td colspan="5">${transaction.bankAccount || ''}</td>
                    </tr>

                    <tr><th>æ‘˜è¦</th><td colspan="5" class="h-16 align-top">${transaction.summary}</td></tr>
                    <tr><th>å‚™è¨»</th><td colspan="5">${transaction.note || ''}</td></tr>
                </table>
                <div class="attachment-area">æ†‘ è­‰ é» è²¼ è™•</div>
                <div class="text-xs mb-1">åˆè¨ˆæ–°å°å¹£ï¼š<span class="text-base ml-2">${digitToChinese(transaction.amount)}</span></div>
                
                <table class="preview-table text-center" style="width:100%; border-collapse:collapse;">
                    <tr>
                        <th style="width:20%; border:1px solid #000;">ç†äº‹é•·</th>
                        <th style="width:20%; border:1px solid #000;">ç¸½å¹¹äº‹</th>
                        <th style="width:20%; border:1px solid #000;">æœƒè¨ˆ</th>
                        <th style="width:20%; border:1px solid #000;">é©—æ”¶è­‰æ˜</th>
                        <th style="width:20%; border:1px solid #000;">ç¶“è¾¦äºº</th>
                    </tr>
                    <tr>
                        <td style="height:80px; border:1px solid #000;"></td>
                        <td style="height:80px; border:1px solid #000;"></td>
                        <td style="height:80px; border:1px solid #000;"></td>
                        <td style="height:80px; border:1px solid #000;"></td>
                        <td style="height:80px; border:1px solid #000;"></td>
                    </tr>
                </table>
            `;
            contentDiv.innerHTML = content;
            document.getElementById('print-modal').classList.remove('hidden');
        }

        // --- Data Operations ---
        
        document.getElementById('entry-form').onsubmit = async (e) => { 
            e.preventDefault(); 
            if(!state.apiUrl) return showToast('è«‹å…ˆé€£ç·š','error'); 
            
            const isEdit=document.getElementById('inp-id').value!==""; 
            const btn=document.getElementById('btn-submit'); 
            btn.disabled=true; 
            
            const formData={ 
                action: isEdit?'edit':'add', 
                id: isEdit?document.getElementById('inp-id').value:Date.now().toString(), 
                date:document.getElementById('inp-date').value, 
                type:document.getElementById('inp-type').value, 
                projectId:document.getElementById('inp-project').value, 
                category:document.getElementById('inp-category').value, 
                summary:document.getElementById('inp-summary').value, 
                amount:document.getElementById('inp-amount').value, 
                payee:document.getElementById('inp-payee').value, 
                bankAccount:document.getElementById('inp-bank-account').value, // æ–°å¢åŒ¯æ¬¾å¸³è™Ÿ
                note:document.getElementById('inp-note').value, 
                createdBy:state.currentUser.id 
            }; 
            
            try { 
                showLoading(true);
                await apiCall(formData);
                
                if(isEdit){ 
                    const idx=state.transactions.findIndex(t=>t.id==formData.id); 
                    if(idx!==-1){ 
                        formData.createdBy=state.transactions[idx].createdBy; 
                        state.transactions[idx]=formData; 
                    } 
                } else { 
                    state.transactions.unshift(formData); 
                } 
                
                updateUI(); 
                cancelEdit(); 
                if(!isEdit && formData.type==='expense'){ 
                    openVoucher(formData); 
                    showToast('å„²å­˜æˆåŠŸï¼å¯ä¸‹è¼‰ PDF'); 
                } else { 
                    showToast('å„²å­˜æˆåŠŸ'); 
                } 
            } catch(err){ 
                showToast('å„²å­˜å¤±æ•—ï¼š' + err.message, 'error'); 
                console.error(err);
            } finally { 
                btn.disabled=false; 
                showLoading(false);
            } 
        };

        async function deleteItem(id) {
            if(!confirm('ç¢ºå®šåˆªé™¤ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) return;
            const originalList = [...state.transactions];
            state.transactions = state.transactions.filter(t=>String(t.id)!==String(id));
            updateUI();
            try {
                showLoading(true);
                await apiCall({action:'delete', id:id});
                showToast('åˆªé™¤æˆåŠŸ');
            } catch(err) {
                state.transactions = originalList;
                updateUI();
                showToast('åˆªé™¤å¤±æ•—ï¼š' + err.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function updateUI() { 
            if(!state.currentUser) return; 
            const user=state.currentUser; 
            const isAdmin=user.role==='admin'; 

            const inc=state.transactions.filter(t=>t.type==='income').reduce((a,c)=>a+(+c.amount||0),0); 
            const exp=state.transactions.filter(t=>t.type==='expense').reduce((a,c)=>a+(+c.amount||0),0); 
            document.getElementById('total-income').innerText='$'+inc.toLocaleString(); 
            document.getElementById('total-expense').innerText='$'+exp.toLocaleString(); 
            
            const pStats=document.getElementById('project-stats'); 
            pStats.innerHTML=''; 
            const pList=document.getElementById('projects-list-content'); 
            pList.innerHTML=''; 
            
            state.projects.forEach(p=>{ 
                const used=state.transactions.filter(t=>String(t.projectId)===String(p.id)&&t.type==='expense').reduce((a,c)=>a+(+c.amount||0),0); 
                const pct=Math.min(Math.round(used/(p.budget||1)*100)||0,100); 
                pStats.innerHTML+=`<div class="mb-3"><div class="flex justify-between text-sm mb-1"><span>${p.name}</span><span class="text-slate-500">$${used.toLocaleString()} / ${(p.budget||0).toLocaleString()}</span></div><div class="bg-slate-100 rounded-full h-2"><div class="h-2 rounded-full ${pct>90?'bg-rose-500':pct>70?'bg-amber-400':'bg-teal-500'}" style="width:${pct}%"></div></div></div>`; 
                pList.innerHTML+=`<div class="border border-slate-200 rounded-lg p-3 flex justify-between items-center"><div><div class="font-bold text-slate-700">${p.name}</div><div class="text-xs text-slate-500">${p.funder||''}</div></div><div class="text-right"><div class="font-mono font-bold text-teal-700">$${(p.budget||0).toLocaleString()}</div></div></div>`; 
            }); 
            
            const pSelect=document.getElementById('inp-project'); 
            const savedP=pSelect.value; 
            pSelect.innerHTML=state.projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join(''); 
            if(savedP)pSelect.value=savedP; 
            updateCategories(); 
            
            const tbody=document.getElementById('list-body'); 
            tbody.innerHTML=state.transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t=>{ 
                const projName=state.projects.find(p=>String(p.id)===String(t.projectId))?.name||'(æœªçŸ¥)'; 
                const tString=JSON.stringify(t).replace(/'/g,"&#39;"); 
                const canModify=(isAdmin||String(t.createdBy)===String(user.id)); 
                const safeDate=(t.date||'').split('T')[0]; 
                return `<tr class="hover:bg-slate-50 group">
                    <td class="px-4 py-3 align-top">
                        <div class="font-mono text-slate-500 text-xs">${safeDate}</div>
                        <div class="text-xs text-slate-400 truncate max-w-[100px]">${projName}</div>
                        <div class="text-sm font-medium text-slate-800">${t.summary}</div>
                    </td>
                    <td class="px-4 py-3 text-right align-top">
                        <div class="font-mono font-bold ${t.type==='income'?'text-emerald-600':'text-rose-600'}">
                            ${t.type==='income'?'+':'-'}${Number(t.amount).toLocaleString()}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center align-top">
                        <div class="flex justify-center space-x-1">
                            ${(t.type==='expense')?`<button onclick='openVoucher(${tString})' class="p-1.5 text-slate-400 hover:text-teal-600 hover:bg-teal-50 rounded"><i data-lucide="printer" class="w-4 h-4"></i></button>`:''}
                            ${canModify?`<button onclick='startEdit(${JSON.stringify(tString)})' class="p-1.5 text-slate-400 hover:text-amber-500 hover:bg-amber-50 rounded"><i data-lucide="edit-3" class="w-4 h-4"></i></button><button onclick="deleteItem('${t.id}')" class="p-1.5 text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`:'<span class="p-1.5 text-slate-300"><i data-lucide="lock" class="w-4 h-4"></i></span>'}
                        </div>
                    </td>
                </tr>`; 
            }).join(''); 
            lucide.createIcons(); 
        }

        function startEdit(tString){
            const t=JSON.parse(tString);
            document.getElementById('inp-id').value=t.id;
            document.getElementById('inp-date').value=(t.date||'').split('T')[0];
            document.getElementById('inp-amount').value=t.amount;
            document.getElementById('inp-summary').value=t.summary;
            document.getElementById('inp-payee').value=t.payee;
            document.getElementById('inp-bank-account').value=t.bankAccount || ''; // è®€å–åŒ¯æ¬¾å¸³è™Ÿ
            document.getElementById('inp-note').value=t.note;
            setType(t.type);
            setTimeout(()=>{
                document.getElementById('inp-project').value=t.projectId;
                document.getElementById('inp-category').value=t.category;
            },50);
            document.getElementById('form-title').innerText="ä¿®æ”¹ç´€éŒ„";
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('btn-submit').innerHTML='<i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i> ç¢ºèªæ›´æ–°';
            document.getElementById('btn-submit').className='w-full bg-amber-500 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center';
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            switchTab('entry');
        }

        function cancelEdit(){
            document.getElementById('entry-form').reset();
            document.getElementById('inp-id').value="";
            document.getElementById('inp-date').value=new Date().toISOString().split('T')[0];
            document.getElementById('form-title').innerText="æ–°å¢ç´€éŒ„";
            document.getElementById('edit-mode-indicator').classList.add('hidden');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            setType('expense');
        }
        
        function updateCategories(){const type=document.getElementById('inp-type').value;const cSelect=document.getElementById('inp-category');const opts=state.categories.filter(c=>c.type===type);cSelect.innerHTML=opts.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');}
        function setType(t){document.getElementById('inp-type').value=t;const btnE=document.getElementById('btn-expense');const btnI=document.getElementById('btn-income');const btnS=document.getElementById('btn-submit');if(t==='expense'){btnE.className='flex-1 py-3 rounded-md text-sm font-bold bg-white text-rose-600 shadow-sm transition-all';btnI.className='flex-1 py-3 rounded-md text-sm font-bold text-slate-500 transition-all';btnS.innerHTML='<i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜ä¸¦åˆ—å°';btnS.className='w-full bg-rose-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center';}else{btnI.className='flex-1 py-3 rounded-md text-sm font-bold bg-white text-emerald-600 shadow-sm transition-all';btnE.className='flex-1 py-3 rounded-md text-sm font-bold text-slate-500 transition-all';btnS.innerHTML='<i data-lucide="save" class="w-5 h-5 mr-2"></i> å„²å­˜';btnS.className='w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center';}updateCategories();}
        function saveAndConnect(){const url=document.getElementById('api-url-input').value.trim();if(!url)return showToast('è«‹è¼¸å…¥ç¶²å€','error');localStorage.setItem('onanip_url',url);state.apiUrl=url;fetchData();}
        function showSettingsOnly(){document.getElementById('login-overlay').classList.add('hidden');switchTab('settings');}
        function logout(){state.currentUser=null;document.getElementById('login-id').value='';document.getElementById('login-pwd').value='';document.getElementById('login-msg').classList.add('hidden');document.getElementById('login-overlay').classList.remove('hidden');document.getElementById('navbar').classList.replace('bg-teal-700','bg-slate-700');}
        function switchTab(id){document.querySelectorAll('.view-section').forEach(el=>el.classList.add('hidden'));document.getElementById('view-'+id).classList.remove('hidden');document.querySelectorAll('.nav-btn').forEach(b=>b.classList.replace('text-teal-600','text-slate-400'));const map={'dashboard':0,'entry':1,'list':2,'projects':3};if(map[id]!==undefined&&document.querySelectorAll('.nav-btn')[map[id]])document.querySelectorAll('.nav-btn')[map[id]].classList.replace('text-slate-400','text-teal-600');document.querySelectorAll('.desktop-nav-btn').forEach(b=>{b.classList.remove('text-teal-300','bg-white/10');b.classList.add('text-slate-300','hover:bg-white/10');});if(map[id]!==undefined&&document.querySelectorAll('.desktop-nav-btn')[map[id]]){const b=document.querySelectorAll('.desktop-nav-btn')[map[id]];b.classList.remove('text-slate-300','hover:bg-white/10');b.classList.add('text-teal-300','bg-white/10');}}
        function digitToChinese(n){const digit=['é›¶','å£¹','è²³','åƒ','è‚†','ä¼','é™¸','æŸ’','æŒ','ç–'];const unit=[['å…ƒ','è¬','å„„'],['','æ‹¾','ä½°','ä»Ÿ']];let num=Math.abs(n);let s='';for(let i=0;i<unit[0].length&&num>0;i++){let p='';for(let j=0;j<unit[1].length&&num>0;j++){p=digit[num%10]+unit[1][j]+p;num=Math.floor(num/10);}s=p.replace(/(é›¶.)*é›¶$/,'').replace(/^$/,'é›¶')+unit[0][i]+s;}return s.replace(/(é›¶.)*é›¶å…ƒ/,'å…ƒ').replace(/(é›¶.)+/g,'é›¶').replace(/^æ•´$/,'é›¶å…ƒæ•´');}
        function showLoading(show){document.getElementById('loading').classList.toggle('hidden',!show);}
        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            if (toastTimeout) clearTimeout(toastTimeout);
            t.innerText = msg;
            t.classList.remove('hidden');
            const baseClass = "fixed top-20 right-4 px-6 py-3 rounded-lg shadow-xl z-[300] text-white transition-all duration-300 transform";
            const bgClass = type === 'error' ? 'bg-rose-600' : 'bg-emerald-600';
            t.className = `${baseClass} ${bgClass} translate-y-0 opacity-100`;
            toastTimeout = setTimeout(() => {
                t.className = `${baseClass} ${bgClass} translate-y-[-20px] opacity-0`;
                setTimeout(() => {
                    t.classList.add('hidden');
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
